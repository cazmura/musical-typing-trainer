<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Typing Trainer - éŸ³éŸ¿ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent: #4CAF50;
            --error: #f44336;
            --border: #dddddd;
            --key-bg: #ffffff;
            --key-active: #4CAF50;
            --key-error: #f44336;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent: #66BB6A;
            --error: #ef5350;
            --border: #444444;
            --key-bg: #2d2d2d;
            --key-active: #66BB6A;
            --key-error: #ef5350;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
        }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ«ã¯éè¡¨ç¤ºï¼ˆçµµæ–‡å­—ã®ã¿è¡¨ç¤ºï¼‰ */
        header .controls #historyBtnHeader,
        header .controls #relaxBtn {
            display: none;
        }

        h1 {
            font-size: 28px;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s, transform 0.1s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: var(--text-secondary);
        }

        button.danger {
            background: var(--error);
        }

        .theme-toggle {
            padding: 8px 12px;
            font-size: 18px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .typing-area {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 10px;
            margin-bottom: 30px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .text-display {
            font-size: 32px;
            letter-spacing: 2px;
            line-height: 1.5;
            text-align: center;
            margin-bottom: 20px;
        }

        .char {
            display: inline-block;
            padding: 2px;
            transition: all 0.2s;
            min-width: 8px;
        }
        
        .char.space {
            min-width: 16px;
            height: 1em;
            margin: 0 2px;
            opacity: 0.7;
            position: relative;
            display: inline-block;
            vertical-align: baseline;
        }
        
        .char.space::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 2px;
            right: 2px;
            height: 2px;
            background: var(--border);
        }

        .char.current {
            background: var(--accent);
            color: white;
            transform: scale(1.2);
            animation: pulse 1s infinite;
        }
        /* ä¸€æ™‚åœæ­¢ä¸­ã¯å•é¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆã®ç‚¹æ»…ã‚’åœæ­¢ */
        .paused .char.current {
            animation: none !important;
            opacity: 1 !important;
        }
        
        .char.space.current {
            background: transparent;
            opacity: 1;
            box-shadow: 0 3px 12px rgba(76, 175, 80, 0.5);
        }
        
        .char.space.current::after {
            background: var(--accent);
            height: 3px;
            bottom: -6px;
        }

        .char.correct {
            color: var(--accent);
        }
        
        .char.space.correct {
            background: transparent;
            opacity: 0.8;
        }
        
        .char.space.correct::after {
            background: var(--accent);
            height: 2px;
            bottom: -6px;
        }

        .char.incorrect {
            color: var(--error);
            background: rgba(244, 67, 54, 0.1);
            font-weight: bold;
        }
        
        .char.space.incorrect {
            background: rgba(244, 67, 54, 0.15);
            opacity: 1;
            box-shadow: 0 3px 12px rgba(244, 67, 54, 0.4);
            border-radius: 4px;
        }
        
        .char.space.incorrect::after {
            background: var(--error);
            height: 3px;
            bottom: -6px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .virtual-keyboard {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
        }

        .key {
            min-width: 40px;
            height: 40px;
            padding: 5px;
            background: var(--key-bg);
            border: 2px solid var(--border);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.1s;
            cursor: default;
        }

        .key.space {
            min-width: 200px;
        }

        .key.active {
            background: var(--key-active);
            color: white;
            transform: scale(0.95);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .key.error {
            background: var(--key-error);
            color: white;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .settings-panel {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group label {
            font-weight: bold;
            color: var(--text-secondary);
        }

        select, input[type="range"], input[type="number"] {
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 5px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="range"] {
            width: 100%;
        }

        .volume-display {
            text-align: center;
            font-size: 18px;
            color: var(--accent);
        }

        .results-screen {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
        }

        .rank {
            font-size: 72px;
            font-weight: bold;
            color: var(--accent);
            margin: 20px 0;
        }

        .rank.S { color: #FFD700; }
        .rank.A { color: #4CAF50; }
        .rank.B { color: #2196F3; }
        .rank.C { color: #FF9800; }
        .rank.D { color: #f44336; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-item {
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .history-panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .guide-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .guide-section {
            margin-bottom: 30px;
        }

        .guide-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .guide-section p {
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .guide-section ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .guide-section li {
            margin-bottom: 8px;
        }

        .stat-explanation {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .stat-explanation strong {
            color: var(--accent);
        }

        .keyboard-hint {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 5px;
            display: inline-block;
            font-family: monospace;
            font-weight: bold;
            margin: 0 5px;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .feature-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .feature-item h4 {
            color: var(--accent);
            margin-bottom: 8px;
        }

        .hidden {
            display: none !important;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--accent);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .text-display {
                font-size: 24px;
            }

            .key {
                min-width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .key.space {
                min-width: 150px;
            }
        }

        /* ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ */
        .relax-active {
            position: relative;
        }

        .relax-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .relax-mode .stats-bar {
            display: none !important;
        }

        .relax-mode .typing-area {
            min-height: 300px;
        }

        .relax-text {
            font-size: 28px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-container {
            position: relative;
        }

        .menu-button {
            position: relative;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 20px;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }

        .menu-dropdown.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
            font-size: 14px;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 5px 0;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            display: none;
        }

        .menu-overlay.active {
            display: block;
        }

        /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <h1>ğŸ¹ Musical Typing Trainer</h1>
            <div class="controls">
                <button onclick="app.showHistory()">ğŸ“Š <span id="historyBtnHeader">History</span></button>
                <button onclick="app.showRelaxMode()">ğŸµ <span id="relaxBtn">Relax Mode</span></button>
                <button class="theme-toggle" onclick="app.toggleTheme()">ğŸŒ“</button>
                <div class="menu-container">
                    <button class="menu-button" onclick="app.toggleMenu()">â˜° Menu</button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <button class="menu-item" onclick="app.showGuide(); app.closeMenu();">
                            <span>â“</span>
                            <span id="guideBtn">Guide</span>
                        </button>
                        <div class="menu-divider"></div>
                        <button class="menu-item" onclick="app.showSettings(); app.closeMenu();">
                            <span>âš™ï¸</span>
                            <span id="settingsBtn">Settings</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <div class="menu-overlay" id="menuOverlay" onclick="app.closeMenu()"></div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-label">Progress</div>
                <div class="stat-value" id="progressStat">0/10</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">WPM</div>
                <div class="stat-value" id="wpmStat">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="accuracyStat">100%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Time</div>
                <div class="stat-value" id="timeStat">0:00</div>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="typing-area" id="typingArea">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="text-display" id="textDisplay">
                Press Start button or SPACE key to begin practice
            </div>
            <div style="margin-top: 20px;">
                <button id="startBtn" onclick="app.startPractice()">ğŸš€ Start</button>
                <button id="pauseBtn" class="secondary hidden" onclick="app.pausePractice()">â¸ï¸ Pause</button>
                <button id="resumeBtn" class="secondary hidden" onclick="app.resumePractice()">â–¶ï¸ Resume</button>
                <button id="resetBtn" class="danger hidden" onclick="app.resetPractice()">ğŸ”„ Reset</button>
            </div>
        </div>

        <!-- ãƒãƒ¼ãƒãƒ£ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ -->
        <div class="virtual-keyboard" id="virtualKeyboard">
            <div class="keyboard-row">
                <div class="key" data-key="1">1</div>
                <div class="key" data-key="2">2</div>
                <div class="key" data-key="3">3</div>
                <div class="key" data-key="4">4</div>
                <div class="key" data-key="5">5</div>
                <div class="key" data-key="6">6</div>
                <div class="key" data-key="7">7</div>
                <div class="key" data-key="8">8</div>
                <div class="key" data-key="9">9</div>
                <div class="key" data-key="0">0</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key="q">Q</div>
                <div class="key" data-key="w">W</div>
                <div class="key" data-key="e">E</div>
                <div class="key" data-key="r">R</div>
                <div class="key" data-key="t">T</div>
                <div class="key" data-key="y">Y</div>
                <div class="key" data-key="u">U</div>
                <div class="key" data-key="i">I</div>
                <div class="key" data-key="o">O</div>
                <div class="key" data-key="p">P</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key="a">A</div>
                <div class="key" data-key="s">S</div>
                <div class="key" data-key="d">D</div>
                <div class="key" data-key="f">F</div>
                <div class="key" data-key="g">G</div>
                <div class="key" data-key="h">H</div>
                <div class="key" data-key="j">J</div>
                <div class="key" data-key="k">K</div>
                <div class="key" data-key="l">L</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key="z">Z</div>
                <div class="key" data-key="x">X</div>
                <div class="key" data-key="c">C</div>
                <div class="key" data-key="v">V</div>
                <div class="key" data-key="b">B</div>
                <div class="key" data-key="n">N</div>
                <div class="key" data-key="m">M</div>
            </div>
            <div class="keyboard-row">
                <div class="key space" data-key=" ">SPACE</div>
            </div>
        </div>
    </div>

    <script>
        // éŸ³æºã‚·ã‚¹ãƒ†ãƒ 
        class AudioSystem {
            constructor() {
                this.audioContext = null;
                this.masterVolume = 0.5;
                this.soundTheme = 'piano';
                this.activeOscillators = new Map();
                this.initAudioContext();
            }

            initAudioContext() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // éŸ³éšãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ”ã‚¢ãƒã®å‘¨æ³¢æ•°ï¼‰
            getFrequency(key) {
                const frequencies = {
                    'a': 261.63, 'b': 293.66, 'c': 329.63, 'd': 349.23, 'e': 392.00,
                    'f': 440.00, 'g': 493.88, 'h': 523.25, 'i': 587.33, 'j': 659.25,
                    'k': 698.46, 'l': 783.99, 'm': 830.61, 'n': 880.00, 'o': 987.77,
                    'p': 1046.50, 'q': 1108.73, 'r': 1174.66, 's': 1318.51, 't': 1396.91,
                    'u': 1567.98, 'v': 1661.22, 'w': 1760.00, 'x': 1975.53, 'y': 2093.00,
                    'z': 2217.46, '1': 220.00, '2': 246.94, '3': 277.18, '4': 311.13,
                    '5': 369.99, '6': 415.30, '7': 466.16, '8': 554.37, '9': 622.25,
                    '0': 739.99, ' ': 130.81
                };
                return frequencies[key.toLowerCase()] || 440;
            }

            playSound(key) {
                if (!this.audioContext) {
                    this.initAudioContext();
                }

                // AudioContextã‚’å†é–‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                // éŸ³æºãƒ†ãƒ¼ãƒã«å¿œã˜ãŸæ³¢å½¢é¸æŠ
                switch (this.soundTheme) {
                    case 'piano':
                        oscillator.type = 'sine';
                        break;
                    case 'drum':
                        oscillator.type = 'square';
                        break;
                    case 'synth':
                        oscillator.type = 'sawtooth';
                        break;
                    case 'ambient':
                        oscillator.type = 'triangle';
                        break;
                }

                oscillator.frequency.setValueAtTime(this.getFrequency(key), now);
                
                // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—è¨­å®š
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(this.masterVolume, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.start(now);
                oscillator.stop(now + 0.3);

                // åŒæ™‚æŠ¼ã—å¯¾å¿œã®ãŸã‚ã€ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’è¨˜éŒ²
                const oscKey = key + Date.now();
                this.activeOscillators.set(oscKey, oscillator);
                
                oscillator.onended = () => {
                    this.activeOscillators.delete(oscKey);
                };
            }

            setVolume(volume) {
                this.masterVolume = Math.max(0, Math.min(1, volume));
            }

            setSoundTheme(theme) {
                this.soundTheme = theme;
            }
        }

        // è¨€èªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const translations = {
            ja: {
                title: "ğŸ¹ Musical Typing Trainer",
                langToggle: "EN",
                guide: "ã‚¬ã‚¤ãƒ‰",
                settings: "è¨­å®š",
                history: "å±¥æ­´",
                progress: "é€²æ—",
                accuracy: "æ­£ç¢ºç‡",
                time: "æ™‚é–“",
                start: "ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆ",
                pause: "â¸ï¸ ä¸€æ™‚åœæ­¢",
                resume: "â–¶ï¸ å†é–‹",
                reset: "ğŸ”„ ãƒªã‚»ãƒƒãƒˆ",
                startMessage: "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ç·´ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„",
                // è¨­å®šç”»é¢
                settingsTitle: "âš™ï¸ è¨­å®š",
                generalSettings: "ä¸€èˆ¬è¨­å®š",
                problemManagement: "å•é¡Œç®¡ç†",
                problemManagementDesc: "æ—¢å­˜ã®å•é¡Œã‚’ç¢ºèªã—ãŸã‚Šã€ã‚«ã‚¹ã‚¿ãƒ å•é¡Œã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚",
                totalProblems: "åˆè¨ˆå•é¡Œæ•°",
                default: "æ—¢å­˜",
                custom: "ã‚«ã‚¹ã‚¿ãƒ ",
                andMore: "ä»– {count}ä»¶",
                difficulty: "é›£æ˜“åº¦",
                beginner: "åˆç´š",
                intermediate: "ä¸­ç´š",
                advanced: "ä¸Šç´š",
                problemCount: "å•é¡Œæ•°",
                problemSource: "å•é¡Œã®å‡ºé¡Œå…ƒ",
                defaultProblems: "æ—¢å­˜ã®å•é¡Œã®ã¿",
                customProblemsOnly: "ã‚«ã‚¹ã‚¿ãƒ å•é¡Œã®ã¿",
                bothProblems: "æ—¢å­˜ã®å•é¡Œã¨ã‚«ã‚¹ã‚¿ãƒ å•é¡Œ",
                problemSourceChanged: "å•é¡Œã®å‡ºé¡Œå…ƒã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
                soundTheme: "éŸ³æºãƒ†ãƒ¼ãƒ",
                piano: "ãƒ”ã‚¢ãƒ",
                drum: "ãƒ‰ãƒ©ãƒ ",
                synth: "ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼",
                ambient: "ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆ",
                volume: "éŸ³é‡",
                resetSettings: "è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ",
                exportData: "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                close: "é–‰ã˜ã‚‹",
                // çµæœç”»é¢
                complete: "ğŸ‰ ç·´ç¿’å®Œäº†ï¼",
                totalScore: "ç·åˆã‚¹ã‚³ã‚¢",
                avgWPM: "å¹³å‡WPM",
                accuracyRate: "æ­£ç¢ºç‡",
                correctTypes: "æ­£ã‚¿ã‚¤ãƒ—æ•°",
                missTypes: "ãƒŸã‚¹ã‚¿ã‚¤ãƒ—æ•°",
                elapsedTime: "æ‰€è¦æ™‚é–“",
                seconds: "ç§’",
                retry: "ã‚‚ã†ä¸€åº¦",
                pressSpaceToRetry: "ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚‚ã†ä¸€åº¦",
                // å±¥æ­´ç”»é¢
                historyTitle: "ğŸ“Š ã‚¹ã‚³ã‚¢å±¥æ­´",
                rank: "ãƒ©ãƒ³ã‚¯",
                score: "ã‚¹ã‚³ã‚¢",
                date: "æ—¥æ™‚",
                delete: "å‰Šé™¤",
                deleteAll: "å…¨å±¥æ­´ã‚’å‰Šé™¤",
                noHistory: "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“",
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                difficultyChanged: "é›£æ˜“åº¦ã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
                problemCountChanged: "å•é¡Œæ•°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
                soundThemeChanged: "éŸ³æºãƒ†ãƒ¼ãƒã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
                settingsReset: "è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ",
                dataExported: "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ",
                historyDeleted: "è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                allHistoryDeleted: "å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                confirmReset: "è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?",
                confirmDelete: "ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹?",
                confirmDeleteAll: "å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹?",
                // ã‚¬ã‚¤ãƒ‰
                guideTitle: "ğŸ“– Musical Typing Trainer ã‚¬ã‚¤ãƒ‰",
                aboutTitle: "ğŸ¹ ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦",
                aboutText: "Musical Typing Trainerã¯ã€ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã«éŸ³æ¥½çš„ãªè¦ç´ ã‚’åŠ ãˆãŸé©æ–°çš„ãªå­¦ç¿’ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã‚­ãƒ¼ã‚’æŠ¼ã™ãŸã³ã«éŸ³ãŒé³´ã‚Šã€æ¥½ã—ã¿ãªãŒã‚‰ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚",
                howToTitle: "ğŸš€ ä½¿ã„æ–¹",
                howToStep1: "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ç·´ç¿’ã‚’é–‹å§‹",
                howToStep2: "ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸæ–‡å­—ã‚’é †ç•ªã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°",
                howToStep3: "æ­£ã—ãå…¥åŠ›ã™ã‚‹ã¨ç·‘è‰²ã«ã€é–“é•ãˆã‚‹ã¨èµ¤è‰²ã«è¡¨ç¤ºã•ã‚Œã¾ã™",
                howToStep4: "é–“é•ãˆãŸå ´åˆã¯ã€æ­£ã—ã„ã‚­ãƒ¼ã‚’æŠ¼ã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™",
                howToStep5: "è¨­å®šã—ãŸå•é¡Œæ•°ã‚’å®Œäº†ã™ã‚‹ã¨çµæœç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™",
                statsTitle: "ğŸ“Š å„æ•°å€¤ã®èª¬æ˜",
                progressDesc: "ç¾åœ¨ä½•å•ç›®ã‚’è§£ã„ã¦ã„ã‚‹ã‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ä¾‹: 5/10 = 10å•ä¸­5å•ç›®",
                wpmDesc: "1åˆ†é–“ã«å…¥åŠ›ã§ãã‚‹å˜èªæ•°ã‚’è¡¨ã—ã¾ã™ã€‚ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é€Ÿåº¦ã®æŒ‡æ¨™ã¨ã—ã¦åºƒãä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚",
                wpmNote: "â€» 5æ–‡å­— = 1å˜èªã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™",
                wpmLevel1: "0-20 WPM: åˆå¿ƒè€…",
                wpmLevel2: "20-40 WPM: å¹³å‡çš„",
                wpmLevel3: "40-60 WPM: ä¸Šç´šè€…",
                wpmLevel4: "60+ WPM: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«",
                accuracyDesc: "æ­£ã—ãå…¥åŠ›ã—ãŸæ–‡å­—ã®å‰²åˆã‚’ç¤ºã—ã¾ã™ã€‚é«˜ã„æ­£ç¢ºç‡ã‚’ç¶­æŒã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚",
                accuracyLevel1: "95%ä»¥ä¸Š: å„ªç§€",
                accuracyLevel2: "90-95%: è‰¯å¥½",
                accuracyLevel3: "85-90%: è¦æ”¹å–„",
                accuracyLevel4: "85%æœªæº€: ç·´ç¿’ãŒå¿…è¦",
                timeDesc: "ç·´ç¿’é–‹å§‹ã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ä¸€æ™‚åœæ­¢ä¸­ã®æ™‚é–“ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚",
                rankTitle: "ğŸ¯ ãƒ©ãƒ³ã‚¯è©•ä¾¡",
                rankDesc: "ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã€ã‚ãªãŸã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å¿œã˜ã¦ãƒ©ãƒ³ã‚¯ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚",
                rankS: "ãƒ©ãƒ³ã‚¯S: ã‚¹ã‚³ã‚¢500ä»¥ä¸Š - å“è¶Šã—ãŸæŠ€è¡“ï¼",
                rankA: "ãƒ©ãƒ³ã‚¯A: ã‚¹ã‚³ã‚¢400-499 - ç´ æ™´ã‚‰ã—ã„ï¼",
                rankB: "ãƒ©ãƒ³ã‚¯B: ã‚¹ã‚³ã‚¢300-399 - è‰¯å¥½ã§ã™",
                rankC: "ãƒ©ãƒ³ã‚¯C: ã‚¹ã‚³ã‚¢200-299 - ã‚‚ã†å°‘ã—ï¼",
                rankD: "ãƒ©ãƒ³ã‚¯D: ã‚¹ã‚³ã‚¢200æœªæº€ - ç·´ç¿’ã‚ã‚‹ã®ã¿ï¼",
                scoreFormula: "ã‚¹ã‚³ã‚¢ã¯ WPM Ã— æ­£ç¢ºç‡ Ã— 10 ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚",
                soundTitle: "ğŸµ éŸ³éŸ¿æ©Ÿèƒ½",
                pianoDesc: "å„ã‚­ãƒ¼ã«éŸ³éšãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã€ç¾ã—ã„ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã‚’å¥ã§ã¾ã™",
                drumDesc: "ãƒªã‚ºãƒŸã‚«ãƒ«ãªãƒ‰ãƒ©ãƒ ã‚µã‚¦ãƒ³ãƒ‰ã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã«",
                synthDesc: "é›»å­éŸ³æ¥½çš„ãªã‚µã‚¦ãƒ³ãƒ‰ã§æœªæ¥çš„ãªä½“é¨“",
                ambientDesc: "è½ã¡ç€ã„ãŸéŸ³è‰²ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ç·´ç¿’",
                customizeTitle: "âš™ï¸ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º",
                customizeDesc: "è¨­å®šç”»é¢ã‹ã‚‰ä»¥ä¸‹ã®é …ç›®ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ï¼š",
                customizeItem1: "é›£æ˜“åº¦: åˆç´šï¼ˆå˜èªï¼‰ã€ä¸­ç´šï¼ˆçŸ­æ–‡ï¼‰ã€ä¸Šç´šï¼ˆé•·æ–‡ï¼‰ã‹ã‚‰é¸æŠ",
                customizeItem2: "å•é¡Œæ•°: 5å•ã€10å•ã€20å•ã‹ã‚‰é¸æŠ",
                customizeItem3: "éŸ³æºãƒ†ãƒ¼ãƒ: ãŠå¥½ã¿ã®éŸ³è‰²ã‚’é¸æŠ",
                customizeItem4: "éŸ³é‡: 0-100%ã§èª¿æ•´å¯èƒ½",
                customizeItem5: "ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ",
                customizeItem6: "è¨€èª: æ—¥æœ¬èª/è‹±èªã®åˆ‡ã‚Šæ›¿ãˆ",
                tipsTitle: "ğŸ’¡ ä¸Šé”ã®ã‚³ãƒ„",
                tip1: "æ­£ç¢ºæ€§ã‚’å„ªå…ˆ: é€Ÿåº¦ã‚ˆã‚Šã‚‚ã¾ãšæ­£ç¢ºã«å…¥åŠ›ã™ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†",
                tip2: "ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³: åŸºæœ¬ã®æŒ‡ã®ä½ç½®ã‚’å®ˆã‚Šã¾ã—ã‚‡ã†ï¼ˆFãƒ»Jã‚­ãƒ¼ã«äººå·®ã—æŒ‡ï¼‰",
                tip3: "ç”»é¢ã‚’è¦‹ã‚‹: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯ãªãç”»é¢ã‚’è¦‹ã¦å…¥åŠ›ã—ã¾ã—ã‚‡ã†",
                tip4: "æ¯æ—¥ç·´ç¿’: çŸ­æ™‚é–“ã§ã‚‚æ¯æ—¥ç¶šã‘ã‚‹ã“ã¨ãŒä¸Šé”ã®ç§˜è¨£ã§ã™",
                tip5: "ãƒªãƒ©ãƒƒã‚¯ã‚¹: åŠ›ã‚’æŠœã„ã¦ã€éŸ³æ¥½ã‚’æ¥½ã—ã¿ãªãŒã‚‰ç·´ç¿’ã—ã¾ã—ã‚‡ã†",
                visualTitle: "ğŸ¨ è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯",
                visualItem1: "ç·‘è‰²ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ: ç¾åœ¨å…¥åŠ›ã™ã¹ãæ–‡å­—",
                visualItem2: "ç·‘è‰²ã®æ–‡å­—: æ­£ã—ãå…¥åŠ›ã•ã‚ŒãŸæ–‡å­—",
                visualItem3: "èµ¤è‰²ã®æ–‡å­—: é–“é•ã£ã¦å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—ï¼ˆæŠ¼ã—ç›´ã—ãŒå¿…è¦ï¼‰",
                visualItem4: "ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³: ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆç©ºç™½ï¼‰ã‚’è¡¨ã—ã¾ã™",
                visualItem5: "ãƒãƒ¼ãƒãƒ£ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰: æŠ¼ã—ãŸã‚­ãƒ¼ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…‰ã‚Šã¾ã™",
                historyFeatureTitle: "ğŸ“ˆ å±¥æ­´æ©Ÿèƒ½",
                historyFeatureDesc: "éå»ã®ã‚¹ã‚³ã‚¢ã‚’ç¢ºèªã—ã¦ã€è‡ªåˆ†ã®æˆé•·ã‚’è¿½è·¡ã§ãã¾ã™ã€‚å±¥æ­´ç”»é¢ã§ã¯ä»¥ä¸‹ãŒç¢ºèªã§ãã¾ã™ï¼š",
                historyItem1: "æ—¥æ™‚",
                historyItem2: "ãƒ©ãƒ³ã‚¯è©•ä¾¡",
                historyItem3: "ã‚¹ã‚³ã‚¢",
                historyItem4: "WPMï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°é€Ÿåº¦ï¼‰",
                historyItem5: "æ­£ç¢ºç‡",
                historyNote: "â€» æœ€å¤§100ä»¶ã¾ã§ä¿å­˜ã•ã‚Œã¾ã™",
                dataTitle: "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†",
                dataDesc: "ã‚ãªãŸã®è¨­å®šã¨å±¥æ­´ã¯è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚è¨­å®šç”»é¢ã‹ã‚‰ä»¥ä¸‹ã®æ“ä½œãŒå¯èƒ½ã§ã™ï¼š",
                dataItem1: "è¨­å®šã®ãƒªã‚»ãƒƒãƒˆ: åˆæœŸè¨­å®šã«æˆ»ã—ã¾ã™",
                dataItem2: "ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: è¨­å®šã¨å±¥æ­´ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜",
                dataItem3: "å±¥æ­´ã®å‰Šé™¤: å€‹åˆ¥ã¾ãŸã¯å…¨å‰Šé™¤ãŒå¯èƒ½",
                shortcutTitle: "âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ",
                shortcutItem1: ": ç·´ç¿’é–‹å§‹ï¼ˆæœªãƒ—ãƒ¬ã‚¤æ™‚ã®ã¿ï¼‰",
                shortcutItem2: " + æ–‡å­—: å¤§æ–‡å­—å…¥åŠ›",
                shortcutNote: "â€» Shiftã€Ctrlã€Altãªã©ã®ä¿®é£¾ã‚­ãƒ¼ã¯ãƒŸã‚¹åˆ¤å®šã•ã‚Œã¾ã›ã‚“",
                language: "è¨€èª",
                // ã‚«ã‚¹ã‚¿ãƒ å•é¡Œ
                customProblems: "ã‚«ã‚¹ã‚¿ãƒ å•é¡Œ",
                manageProblems: "å•é¡Œã‚’ç®¡ç†",
                addProblem: "å•é¡Œã‚’è¿½åŠ ",
                problemText: "å•é¡Œæ–‡",
                problemDifficulty: "é›£æ˜“åº¦",
                cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
                add: "è¿½åŠ ",
                edit: "ç·¨é›†",
                save: "ä¿å­˜",
                customProblemsTitle: "ğŸ“ ã‚«ã‚¹ã‚¿ãƒ å•é¡Œç®¡ç†",
                noProblemText: "å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                problemAdded: "å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ",
                problemDeleted: "å•é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                problemDeletedAndSourceChanged: "å•é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã‚«ã‚¹ã‚¿ãƒ å•é¡ŒãŒãªããªã£ãŸãŸã‚ã€å‡ºé¡Œå…ƒã‚’ã€Œæ—¢å­˜ã®å•é¡Œã¨ã‚«ã‚¹ã‚¿ãƒ å•é¡Œã€ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚",
                problemUpdated: "å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸ",
                confirmDeleteProblem: "ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹?",
                exportProblems: "å•é¡Œã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                importProblems: "å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
                problemsExported: "å•é¡Œã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ",
                problemsImported: "å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ",
                invalidFile: "ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™",
                noCustomProblems: "ã‚«ã‚¹ã‚¿ãƒ å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“",
                // éŠã³ãƒ¢ãƒ¼ãƒ‰
                relaxMode: "ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰",
                relaxModeTitle: "ğŸµ ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰",
                relaxModeDesc: "éŸ³æ¥½ã¨å¹¾ä½•å­¦æ¨¡æ§˜ã§å¿ƒã‚’ç™’ã—ã¾ã—ã‚‡ã†",
                startRelax: "é–‹å§‹",
                stopRelax: "åœæ­¢",
                selectMelody: "ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’é¸æŠ",
                melody1: "ç©ã‚„ã‹ãªæ³¢",
                melody2: "æ£®ã®æœ",
                melody3: "æ˜Ÿç©ºã®å¤œ",
                melody4: "æ˜¥ã®é¢¨"
            },
            en: {
                title: "ğŸ¹ Musical Typing Trainer",
                langToggle: "æ—¥æœ¬èª",
                guide: "Guide",
                settings: "Settings",
                history: "History",
                progress: "Progress",
                accuracy: "Accuracy",
                time: "Time",
                start: "ğŸš€ Start",
                pause: "â¸ï¸ Pause",
                resume: "â–¶ï¸ Resume",
                reset: "ğŸ”„ Reset",
                startMessage: "Press Start button or SPACE key to begin practice",
                // Settings
                settingsTitle: "âš™ï¸ Settings",
                generalSettings: "General",
                problemManagement: "Problems",
                problemManagementDesc: "View default problems and manage your custom problems.",
                totalProblems: "Total Problems",
                default: "Default",
                custom: "Custom",
                andMore: "and {count} more",
                difficulty: "Difficulty",
                beginner: "Beginner",
                intermediate: "Intermediate",
                advanced: "Advanced",
                problemCount: "Problems",
                problemSource: "Problem Source",
                defaultProblems: "Default Problems Only",
                customProblemsOnly: "Custom Problems Only",
                bothProblems: "Both Default and Custom",
                problemSourceChanged: "Problem source changed",
                soundTheme: "Sound Theme",
                piano: "Piano",
                drum: "Drum",
                synth: "Synthesizer",
                ambient: "Ambient",
                volume: "Volume",
                resetSettings: "Reset Settings",
                exportData: "Export Data",
                close: "Close",
                // Results
                complete: "ğŸ‰ Practice Complete!",
                totalScore: "Total Score",
                avgWPM: "Average WPM",
                accuracyRate: "Accuracy",
                correctTypes: "Correct",
                missTypes: "Mistakes",
                elapsedTime: "Time Elapsed",
                seconds: "sec",
                retry: "Try Again",
                pressSpaceToRetry: "Press SPACE to try again",
                // History
                historyTitle: "ğŸ“Š Score History",
                rank: "Rank",
                score: "Score",
                date: "Date",
                delete: "Delete",
                deleteAll: "Delete All",
                noHistory: "No history available",
                // Messages
                difficultyChanged: "Difficulty changed",
                problemCountChanged: "Problem count changed",
                soundThemeChanged: "Sound theme changed",
                settingsReset: "Settings reset",
                dataExported: "Data exported",
                historyDeleted: "Record deleted",
                allHistoryDeleted: "All history deleted",
                confirmReset: "Reset settings to default?",
                confirmDelete: "Delete this record?",
                confirmDeleteAll: "Delete all history?",
                // Guide
                guideTitle: "ğŸ“– Musical Typing Trainer Guide",
                aboutTitle: "ğŸ¹ About This Site",
                aboutText: "Musical Typing Trainer is an innovative learning tool that adds musical elements to typing practice. With each keystroke producing a sound, you can improve your typing skills while enjoying music.",
                howToTitle: "ğŸš€ How to Use",
                howToStep1: "Press the Start button or SPACE key to begin practice",
                howToStep2: "Type the characters displayed on the screen in order",
                howToStep3: "Correct input is displayed in green, incorrect in red",
                howToStep4: "If you make a mistake, you need to press the correct key again",
                howToStep5: "Results screen appears after completing the set number of problems",
                statsTitle: "ğŸ“Š Statistics Explained",
                progressDesc: "Shows which problem you're currently on. Example: 5/10 = Problem 5 of 10",
                wpmDesc: "Words Per Minute represents typing speed and is widely used as an indicator.",
                wpmNote: "â€» 5 characters = 1 word",
                wpmLevel1: "0-20 WPM: Beginner",
                wpmLevel2: "20-40 WPM: Average",
                wpmLevel3: "40-60 WPM: Advanced",
                wpmLevel4: "60+ WPM: Professional",
                accuracyDesc: "Shows the percentage of correctly typed characters. Maintaining high accuracy is important.",
                accuracyLevel1: "95%+: Excellent",
                accuracyLevel2: "90-95%: Good",
                accuracyLevel3: "85-90%: Needs Improvement",
                accuracyLevel4: "Below 85%: Practice Needed",
                timeDesc: "Displays elapsed time since practice started. Paused time is not included.",
                rankTitle: "ğŸ¯ Rank Evaluation",
                rankDesc: "At the end of a session, you'll receive a rank based on your performance.",
                rankS: "Rank S: Score 500+ - Exceptional skill!",
                rankA: "Rank A: Score 400-499 - Excellent!",
                rankB: "Rank B: Score 300-399 - Good",
                rankC: "Rank C: Score 200-299 - Almost there!",
                rankD: "Rank D: Below 200 - Keep practicing!",
                scoreFormula: "Score is calculated as WPM Ã— Accuracy Ã— 10.",
                soundTitle: "ğŸµ Sound Features",
                pianoDesc: "Each key is assigned a musical note, creating beautiful melodies",
                drumDesc: "Rhythmic drum sounds for an energetic experience",
                synthDesc: "Electronic music sounds for a futuristic experience",
                ambientDesc: "Calm tones for relaxed practice",
                customizeTitle: "âš™ï¸ Customization",
                customizeDesc: "You can customize the following from the settings screen:",
                customizeItem1: "Difficulty: Choose from Beginner (words), Intermediate (phrases), Advanced (sentences)",
                customizeItem2: "Problems: Choose 5, 10, or 20 problems",
                customizeItem3: "Sound Theme: Select your preferred sound",
                customizeItem4: "Volume: Adjustable from 0-100%",
                customizeItem5: "Theme: Switch between Light/Dark mode",
                customizeItem6: "Language: Switch between Japanese/English",
                tipsTitle: "ğŸ’¡ Tips for Improvement",
                tip1: "Prioritize accuracy: Focus on typing correctly before speed",
                tip2: "Home position: Keep fingers in the basic position (index fingers on F and J)",
                tip3: "Look at screen: Type while looking at the screen, not the keyboard",
                tip4: "Daily practice: Consistent daily practice, even if brief, is key to improvement",
                tip5: "Relax: Practice while relaxed and enjoy the music",
                visualTitle: "ğŸ¨ Visual Feedback",
                visualItem1: "Green highlight: Character to be typed next",
                visualItem2: "Green text: Correctly typed character",
                visualItem3: "Red text: Incorrectly typed character (needs retyping)",
                visualItem4: "Underline: Represents space",
                visualItem5: "Virtual keyboard: Keys light up in real-time when pressed",
                historyFeatureTitle: "ğŸ“ˆ History Feature",
                historyFeatureDesc: "View past scores to track your progress. The history screen shows:",
                historyItem1: "Date and time",
                historyItem2: "Rank evaluation",
                historyItem3: "Score",
                historyItem4: "WPM (typing speed)",
                historyItem5: "Accuracy",
                historyNote: "â€» Up to 100 records are saved",
                dataTitle: "ğŸ’¾ Data Management",
                dataDesc: "Your settings and history are automatically saved in the browser. From the settings screen you can:",
                dataItem1: "Reset Settings: Return to default settings",
                dataItem2: "Export Data: Save settings and history as a JSON file",
                dataItem3: "Delete History: Delete individual records or all records",
                shortcutTitle: "âŒ¨ï¸ Keyboard Shortcuts",
                shortcutItem1: ": Start practice (when not playing)",
                shortcutItem2: " + character: Type uppercase",
                shortcutNote: "â€» Modifier keys like Shift, Ctrl, Alt are not counted as mistakes",
                language: "Language",
                // Custom Problems
                customProblems: "Custom Problems",
                manageProblems: "Manage Problems",
                addProblem: "Add Problem",
                problemText: "Problem Text",
                problemDifficulty: "Difficulty",
                cancel: "Cancel",
                add: "Add",
                edit: "Edit",
                save: "Save",
                customProblemsTitle: "ğŸ“ Custom Problems Management",
                noProblemText: "Please enter problem text",
                problemAdded: "Problem added",
                problemDeleted: "Problem deleted",
                problemDeletedAndSourceChanged: "Problem deleted. Since there are no custom problems left, the problem source has been changed to 'Both Default and Custom'.",
                problemUpdated: "Problem updated",
                confirmDeleteProblem: "Delete this problem?",
                exportProblems: "Export Problems",
                importProblems: "Import Problems",
                problemsExported: "Problems exported",
                problemsImported: "Problems imported",
                invalidFile: "Invalid file",
                noCustomProblems: "No custom problems",
                // Relax Mode
                relaxMode: "Relax Mode",
                relaxModeTitle: "ğŸµ Relax Mode",
                relaxModeDesc: "Heal your mind with music and geometric patterns",
                startRelax: "Start",
                stopRelax: "Stop",
                selectMelody: "Select Melody",
                melody1: "Gentle Waves",
                melody2: "Forest Morning",
                melody3: "Starry Night",
                melody4: "Spring Breeze"
            }
        };

        // å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const problemDatabase = {
            beginner: [
                // åŸºæœ¬å˜èªï¼ˆå‹•ç‰©ï¼‰
                'cat', 'dog', 'bird', 'fish', 'bear', 'lion', 'tiger', 'wolf', 'deer', 'duck',
                'cow', 'pig', 'sheep', 'goat', 'horse', 'mouse', 'rabbit', 'snake', 'frog', 'bee',
                // åŸºæœ¬å˜èªï¼ˆè‡ªç„¶ï¼‰
                'sun', 'moon', 'star', 'sky', 'rain', 'snow', 'wind', 'cloud', 'tree', 'leaf',
                'flower', 'grass', 'river', 'lake', 'sea', 'hill', 'rock', 'sand', 'fire', 'water',
                // åŸºæœ¬å˜èªï¼ˆæ—¥å¸¸ï¼‰
                'hand', 'head', 'face', 'eye', 'ear', 'nose', 'mouth', 'foot', 'arm', 'leg',
                'book', 'pen', 'desk', 'chair', 'door', 'window', 'wall', 'floor', 'roof', 'key',
                'food', 'milk', 'bread', 'rice', 'meat', 'egg', 'apple', 'tea', 'cup', 'plate',
                // åŸºæœ¬å˜èªï¼ˆæ™‚é–“ãƒ»å ´æ‰€ï¼‰
                'time', 'day', 'night', 'week', 'year', 'hour', 'home', 'room', 'town', 'city',
                // åŸºæœ¬å˜èªï¼ˆå‹•ä½œãƒ»çŠ¶æ…‹ï¼‰
                'run', 'walk', 'jump', 'swim', 'fly', 'read', 'write', 'sing', 'dance', 'sleep',
                'work', 'play', 'learn', 'teach', 'help', 'love', 'like', 'want', 'need', 'have',
                // åŸºæœ¬å˜èªï¼ˆå½¢å®¹è©ï¼‰
                'big', 'small', 'long', 'short', 'hot', 'cold', 'new', 'old', 'good', 'bad',
                'fast', 'slow', 'high', 'low', 'hard', 'soft', 'clean', 'dirty', 'happy', 'sad'
            ],
            intermediate: [
                // çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚º
                'hello world', 'good morning', 'good night', 'thank you', 'nice to meet you',
                'see you later', 'take care', 'have fun', 'good luck', 'well done',
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ»å­¦ç¿’é–¢é€£
                'typing practice', 'keyboard skills', 'touch typing', 'practice makes perfect',
                'learn something new', 'improve your skills', 'keep practicing', 'stay focused',
                // ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼é–¢é€£
                'computer science', 'web development', 'mobile application', 'user interface',
                'artificial intelligence', 'machine learning', 'data structure', 'algorithm design',
                'software engineering', 'programming language', 'database management', 'cloud computing',
                'cyber security', 'network protocol', 'operating system', 'version control',
                // ãƒ“ã‚¸ãƒã‚¹ãƒ»ä»•äº‹é–¢é€£
                'team collaboration', 'project management', 'time management', 'problem solving',
                'creative thinking', 'critical thinking', 'effective communication', 'leadership skills',
                'customer service', 'sales strategy', 'market research', 'business plan',
                // ç§‘å­¦ãƒ»æ•™è‚²é–¢é€£
                'scientific method', 'research paper', 'case study', 'data analysis',
                'environmental protection', 'sustainable development', 'renewable energy', 'climate change',
                'space exploration', 'medical research', 'genetic engineering', 'quantum physics',
                // æ—¥å¸¸ç”Ÿæ´»
                'healthy lifestyle', 'balanced diet', 'regular exercise', 'mental health',
                'social media', 'online shopping', 'video streaming', 'digital payment',
                'travel abroad', 'cultural exchange', 'language learning', 'hobby activities'
            ],
            advanced: [
                // åè¨€ãƒ»æ ¼è¨€
                'The quick brown fox jumps over the lazy dog',
                'Practice makes perfect in all endeavors of life',
                'Technology is best when it brings people together',
                'Innovation distinguishes between a leader and a follower',
                'The only way to do great work is to love what you do',
                'Success is not final, failure is not fatal, it is the courage to continue that counts',
                'The future belongs to those who believe in the beauty of their dreams',
                'Education is the most powerful weapon which you can use to change the world',
                // ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
                'Writing clean and maintainable code is essential for long-term project success',
                'Understanding data structures and algorithms is fundamental to computer science',
                'Continuous integration and deployment streamline the development workflow',
                'Object-oriented programming promotes code reusability and modularity',
                'Responsive web design ensures optimal user experience across all devices',
                'Microservices architecture enables scalable and flexible application development',
                'Version control systems like Git are crucial for collaborative software development',
                'Automated testing helps maintain code quality and prevents regression bugs',
                // ãƒ“ã‚¸ãƒã‚¹ãƒ»çµŒå–¶
                'Effective communication and collaboration are key to successful team management',
                'Understanding customer needs is essential for developing successful products',
                'Data-driven decision making leads to more accurate and effective business strategies',
                'Building a strong company culture attracts and retains talented employees',
                'Adapting to market changes quickly is crucial for business sustainability',
                'Strategic planning and execution determine long-term organizational success',
                // ç§‘å­¦ãƒ»å­¦è¡“
                'Scientific research requires rigorous methodology and careful data analysis',
                'Climate change poses significant challenges that require global cooperation',
                'Artificial intelligence is transforming industries and reshaping our daily lives',
                'Renewable energy sources are becoming increasingly important for environmental sustainability',
                'Space exploration continues to push the boundaries of human knowledge and capability',
                'Medical advances are extending human lifespan and improving quality of life',
                // å“²å­¦ãƒ»äººç”Ÿ
                'The journey of a thousand miles begins with a single step forward',
                'Learning from mistakes and failures is an important part of personal growth',
                'Maintaining a positive attitude in difficult times requires strength and resilience',
                'Curiosity and continuous learning are essential for personal and professional development',
                'Building meaningful relationships enriches our lives and provides support during challenges',
                'Finding balance between work and personal life contributes to overall happiness and well-being'
            ],
            custom: []
        };

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        class TypingTrainerApp {
            constructor() {
                this.audioSystem = new AudioSystem();
                this.currentText = '';
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isPaused = false;
                this.startTime = null;
                this.pauseTime = null;
                this.totalPauseTime = 0;
                this.correctCount = 0;
                this.incorrectCount = 0;
                this.problemCount = 0;
                this.currentProblem = 0;
                this.difficulty = 'beginner';
                this.problemsPerSession = 10;
                this.problemSource = 'both'; // 'default', 'custom', 'both'
                this.theme = 'light';
                this.language = 'en';
                this.history = [];
                this.customProblems = { beginner: [], intermediate: [], advanced: [] };
                // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç”¨ã®åˆæœŸåŒ–ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ä½¿ã†ï¼‰
                this.graphics = [];
                this.globalParticles = [];
                this.globalRipples = [];
                this.relaxKeyCount = 0;
                this.relaxKeyTimes = [];
                this.loadSettings();
                this.loadHistory();
                this.loadCustomProblems();
                this.setupEventListeners();
                this.updateLanguage();
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
            }

            handleKeyPress(e) {
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚²ãƒ¼ãƒ æœªé–‹å§‹æ™‚ï¼‰
                if (!this.isPlaying && e.key === ' ') {
                    e.preventDefault();
                    this.startPractice();
                    return;
                }
                
                if (!this.isPlaying || this.isPaused) return;
                
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¸¸ã«é˜²æ­¢
                if (e.key === ' ') {
                    e.preventDefault();
                }
                
                const key = e.key;
                
                // ä¿®é£¾ã‚­ãƒ¼ï¼ˆShift, Ctrl, Alt, Metaç­‰ï¼‰ã¯ç„¡è¦–
                const modifierKeys = ['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab', 'Escape', 'Enter', 'Backspace'];
                if (modifierKeys.includes(key)) {
                    return;
                }
                
                // éŸ³ã‚’å†ç”Ÿ
                this.audioSystem.playSound(key);
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’æ›´æ–°
                this.highlightKey(key, true);
                
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
                const expectedChar = this.currentText[this.currentIndex];
                
                if (key === expectedChar) {
                    this.correctCount++;
                    this.markCharacter(this.currentIndex, 'correct');
                    this.currentIndex++;
                    // æˆåŠŸæ™‚ã¯çŸ­æ™‚é–“ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç¢ºå®Ÿã«è§£é™¤
                    setTimeout(() => this.highlightKey(key, false), 200);
                    
                    if (this.currentIndex >= this.currentText.length) {
                        this.nextProblem();
                    } else {
                        this.updateCurrentCharacter();
                    }
                } else {
                    // ãƒŸã‚¹ã—ãŸå ´åˆã¯èµ¤å­—è¡¨ç¤ºã®ã¿ã§ã€æŠ¼ã—ç›´ã—ãŒå¿…è¦
                    this.incorrectCount++;
                    this.markCharacter(this.currentIndex, 'incorrect');
                    
                    // æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
                    this.highlightKey(key, true, true);
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰èµ¤å­—ã‚’è§£é™¤ã—ã¦å†åº¦currentã«æˆ»ã™
                    setTimeout(() => {
                        this.markCharacter(this.currentIndex, 'reset');
                        this.updateCurrentCharacter();
                        this.highlightKey(key, false, true);
                    }, 300);
                }
                
                this.updateStats();
            }

            handleKeyUp(e) {
                this.highlightKey(e.key, false);
            }

            highlightKey(key, active, error = false) {
                const keyElement = document.querySelector(`[data-key="${key.toLowerCase()}"]`);
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥ã«å‡¦ç†
                const spaceElement = document.querySelector(`[data-key=" "]`);
                const targetElement = (key === ' ' || key.toLowerCase() === ' ') ? spaceElement : keyElement;
                
                if (targetElement) {
                    if (active) {
                        if (error) {
                            // ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆæ™‚ã¯ active ã‚’æ¶ˆã—ã¦ error ã‚’ä»˜ã‘ã‚‹
                            targetElement.classList.remove('active');
                            targetElement.classList.add('error');
                        } else {
                            // æˆåŠŸãƒã‚¤ãƒ©ã‚¤ãƒˆæ™‚ã¯ error ã‚’æ¶ˆã—ã¦ active ã‚’ä»˜ã‘ã‚‹
                            targetElement.classList.remove('error');
                            targetElement.classList.add('active');
                        }
                    } else {
                        // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯ä¸¡æ–¹å¤–ã™
                        targetElement.classList.remove('active', 'error');
                    }
                }
            }

            startPractice() {
                this.isPlaying = true;
                this.isPaused = false;
                document.body.classList.remove('paused');
                this.currentProblem = 0;
                this.correctCount = 0;
                this.incorrectCount = 0;
                this.startTime = Date.now();
                this.totalPauseTime = 0;
                
                this.loadNextProblem();
                this.updateUI();
                this.updateStats();
                
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('resetBtn').classList.remove('hidden');

                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¡ã‚¤ãƒ³é ˜åŸŸã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ãªã„ãŸã‚ã€
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯ä½œæˆã—ãªã„
                this.relaxCanvas = null;
                this.relaxCtx = null;

                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹
                let globalCanvas = document.getElementById('relaxGlobalCanvas');
                if (!globalCanvas) {
                    globalCanvas = document.createElement('canvas');
                    globalCanvas.id = 'relaxGlobalCanvas';
                    globalCanvas.style.position = 'fixed';
                    globalCanvas.style.top = '0';
                    globalCanvas.style.left = '0';
                    globalCanvas.style.width = '100%';
                    globalCanvas.style.height = '100%';
                    globalCanvas.style.pointerEvents = 'none';
                    globalCanvas.style.zIndex = '500';
                    document.body.appendChild(globalCanvas);
                }
                globalCanvas.width = window.innerWidth;
                globalCanvas.height = window.innerHeight;
                this.globalCanvas = globalCanvas;
                this.globalCtx = globalCanvas.getContext('2d');

                // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŠã‚ˆã³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé…åˆ—åˆæœŸåŒ–
                this.relaxKeyCount = this.relaxKeyCount || 0;
                this.relaxKeyTimes = this.relaxKeyTimes || [];
                this.globalParticles = this.globalParticles || [];
                this.globalRipples = this.globalRipples || [];

                // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆé‡è¤‡è¿½åŠ é˜²æ­¢ï¼‰
                if (!this.resizeHandler) {
                    this.resizeHandler = () => {
                        if (this.relaxCanvas) {
                            const typingArea = document.getElementById('typingArea');
                            if (typingArea) {
                                this.relaxCanvas.width = typingArea.offsetWidth;
                                this.relaxCanvas.height = typingArea.offsetHeight;
                            }
                        }
                        if (this.globalCanvas) {
                            this.globalCanvas.width = window.innerWidth;
                            this.globalCanvas.height = window.innerHeight;
                        }
                    };
                    window.addEventListener('resize', this.resizeHandler);
                }

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹ï¼ˆå¤šé‡é–‹å§‹é˜²æ­¢ï¼‰
                if (!this._visualsAnimating) {
                    this._visualsAnimating = true;
                    this.animateRelax();
                }
            }

            pausePractice() {
                this.isPaused = true;
                this.pauseTime = Date.now();
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('resumeBtn').classList.remove('hidden');
                document.body.classList.add('paused');
            }

            resumePractice() {
                this.isPaused = false;
                this.totalPauseTime += Date.now() - this.pauseTime;
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('resumeBtn').classList.add('hidden');
                document.body.classList.remove('paused');
            }

            resetPractice() {
                this.isPlaying = false;
                this.isPaused = false;
                document.body.classList.remove('paused');
                this.currentIndex = 0;
                this.currentProblem = 0;
                this.correctCount = 0;
                this.incorrectCount = 0;
                this.startTime = null;
                this.totalPauseTime = 0;
                
                document.getElementById('textDisplay').innerHTML = this.t('startMessage');
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('startBtn').innerHTML = this.t('start');
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('resumeBtn').classList.add('hidden');
                document.getElementById('resetBtn').classList.add('hidden');
                
                this.updateStats();
            }

            loadNextProblem() {
                const defaultProblems = problemDatabase[this.difficulty];
                const customProblems = this.customProblems[this.difficulty] || [];
                
                let allProblems = [];
                
                // problemSourceã®è¨­å®šã«å¿œã˜ã¦å•é¡Œã‚’é¸æŠ
                if (this.problemSource === 'default') {
                    allProblems = [...defaultProblems];
                } else if (this.problemSource === 'custom') {
                    allProblems = [...customProblems];
                } else { // 'both'
                    allProblems = [...defaultProblems, ...customProblems];
                }
                
                if (allProblems.length === 0) {
                    this.currentText = 'No problems available';
                } else {
                    this.currentText = allProblems[Math.floor(Math.random() * allProblems.length)];
                }
                
                this.currentIndex = 0;
                this.displayText();
            }

            nextProblem() {
                this.currentProblem++;
                
                if (this.currentProblem >= this.problemsPerSession) {
                    this.finishSession();
                } else {
                    this.loadNextProblem();
                    this.updateStats();
                }
            }

            displayText() {
                const display = document.getElementById('textDisplay');
                display.innerHTML = '';
                
                for (let i = 0; i < this.currentText.length; i++) {
                    const span = document.createElement('span');
                    span.className = 'char';
                    
                    // ã‚¹ãƒšãƒ¼ã‚¹æ–‡å­—ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    if (this.currentText[i] === ' ') {
                        span.classList.add('space');
                        span.innerHTML = '&nbsp;'; // ç©ºç™½ã‚’è¡¨ç¤º
                    } else {
                        span.textContent = this.currentText[i];
                    }
                    
                    if (i === this.currentIndex) {
                        span.classList.add('current');
                    }
                    
                    display.appendChild(span);
                }
            }

            updateCurrentCharacter() {
                const chars = document.querySelectorAll('.char');
                chars.forEach((char, index) => {
                    char.classList.remove('current');
                    if (index === this.currentIndex) {
                        char.classList.add('current');
                    }
                });
            }

            markCharacter(index, status) {
                const chars = document.querySelectorAll('.char');
                if (chars[index]) {
                    if (status === 'reset') {
                        // ãƒªã‚»ãƒƒãƒˆï¼šå…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                        chars[index].classList.remove('current', 'correct', 'incorrect');
                    } else {
                        chars[index].classList.remove('current');
                        chars[index].classList.add(status);
                    }
                }
            }

            updateStats() {
                // é€²æ—
                document.getElementById('progressStat').textContent = 
                    `${this.currentProblem}/${this.problemsPerSession}`;
                
                const progress = (this.currentProblem / this.problemsPerSession) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // WPMè¨ˆç®—
                let wpm = 0;
                if (this.startTime && this.isPlaying) {
                    const elapsedMinutes = (Date.now() - this.startTime - this.totalPauseTime) / 60000;
                    const words = this.correctCount / 5; // 5æ–‡å­— = 1å˜èª
                    wpm = Math.round(words / elapsedMinutes) || 0;
                }
                document.getElementById('wpmStat').textContent = wpm;
                
                // æ­£ç¢ºç‡
                const total = this.correctCount + this.incorrectCount;
                const accuracy = total > 0 ? Math.round((this.correctCount / total) * 100) : 100;
                document.getElementById('accuracyStat').textContent = `${accuracy}%`;
                
                // æ™‚é–“
                let timeText = '0:00';
                if (this.startTime && this.isPlaying) {
                    const elapsed = Math.floor((Date.now() - this.startTime - this.totalPauseTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                document.getElementById('timeStat').textContent = timeText;
            }

            finishSession() {
                this.isPlaying = false;
                
                const totalTime = (Date.now() - this.startTime - this.totalPauseTime) / 1000;
                const total = this.correctCount + this.incorrectCount;
                const accuracy = total > 0 ? (this.correctCount / total) * 100 : 100;
                const wpm = Math.round((this.correctCount / 5) / (totalTime / 60));
                
                const score = this.calculateScore(wpm, accuracy);
                const rank = this.getRank(score);
                
                const result = {
                    date: new Date().toISOString(),
                    score: score,
                    rank: rank,
                    wpm: wpm,
                    accuracy: accuracy.toFixed(1),
                    correct: this.correctCount,
                    incorrect: this.incorrectCount,
                    time: totalTime.toFixed(1),
                    difficulty: this.difficulty
                };
                
                this.saveResult(result);
                this.showResults(result);
            }

            calculateScore(wpm, accuracy) {
                return Math.round(wpm * (accuracy / 100) * 10);
            }

            getRank(score) {
                if (score >= 500) return 'S';
                if (score >= 400) return 'A';
                if (score >= 300) return 'B';
                if (score >= 200) return 'C';
                return 'D';
            }

            showResults(result) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content results-screen">
                        <h2>${this.t('complete')}</h2>
                        <div class="rank ${result.rank}">${result.rank}</div>
                        <div class="results-grid">
                            <div class="result-item">
                                <div class="stat-label">${this.t('totalScore')}</div>
                                <div class="stat-value">${result.score}</div>
                            </div>
                            <div class="result-item">
                                <div class="stat-label">${this.t('avgWPM')}</div>
                                <div class="stat-value">${result.wpm}</div>
                            </div>
                            <div class="result-item">
                                <div class="stat-label">${this.t('accuracyRate')}</div>
                                <div class="stat-value">${result.accuracy}%</div>
                            </div>
                            <div class="result-item">
                                <div class="stat-label">${this.t('correctTypes')}</div>
                                <div class="stat-value">${result.correct}</div>
                            </div>
                            <div class="result-item">
                                <div class="stat-label">${this.t('missTypes')}</div>
                                <div class="stat-value">${result.incorrect}</div>
                            </div>
                            <div class="result-item">
                                <div class="stat-label">${this.t('elapsedTime')}</div>
                                <div class="stat-value">${result.time}${this.t('seconds')}</div>
                            </div>
                        </div>
                        <button onclick="app.resetPractice(); app.closeModal(this);">${this.t('retry')}</button>
                        <p style="text-align: center; opacity: 0.6; margin-top: 15px; font-size: 14px;">
                            ${this.t('pressSpaceToRetry')}
                        </p>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆã—ã¦é–‰ã˜ã‚‹
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.resetPractice();
                        this.closeModal(modal);
                    }
                });
                
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ãƒªã‚»ãƒƒãƒˆ
                const spaceKeyHandler = (e) => {
                    if (e.key === ' ' || e.key === 'Spacebar') {
                        e.preventDefault();
                        this.resetPractice();
                        this.closeModal(modal);
                        document.removeEventListener('keydown', spaceKeyHandler);
                    }
                };
                document.addEventListener('keydown', spaceKeyHandler);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                const observer = new MutationObserver((mutations) => {
                    if (!document.body.contains(modal)) {
                        document.removeEventListener('keydown', spaceKeyHandler);
                        observer.disconnect();
                    }
                });
                observer.observe(document.body, { childList: true });
            }

            closeModal(element) {
                const modal = element.closest('.modal');
                if (modal) {
                    modal.remove();
                }
            }

            showCustomProblems() {
                // å„é›£æ˜“åº¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
                const tabContents = ['beginner', 'intermediate', 'advanced'].map((difficulty, index) => {
                    const defaultProblems = problemDatabase[difficulty] || [];
                    const customProblems = this.customProblems[difficulty] || [];
                    
                    // æ—¢å­˜ã®å•é¡Œã®HTML
                    const defaultProblemsHTML = defaultProblems.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--accent); margin-bottom: 10px; font-size: 16px;">ğŸ“š æ—¢å­˜ã®å•é¡Œ (${defaultProblems.length}ä»¶)</h4>
                            <div style="max-height: 300px; overflow-y: auto; padding: 10px; background: var(--bg-primary); border-radius: 5px; border: 1px solid var(--border);">
                                ${defaultProblems.map((problem, idx) => `
                                    <div style="padding: 8px; margin-bottom: 5px; background: var(--bg-secondary); border-radius: 3px; font-size: 14px;">
                                        ${idx + 1}. ${this.escapeHtml(problem)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '';
                    
                    // ã‚«ã‚¹ã‚¿ãƒ å•é¡Œã®HTML
                    const customProblemsHTML = customProblems.map((problem, idx) => `
                        <div class="history-item" style="display: block; margin-bottom: 10px;">
                            <div style="margin-bottom: 10px;">
                                <strong>${this.escapeHtml(problem)}</strong>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="secondary" data-difficulty="${difficulty}" data-index="${idx}" onclick="app.editProblemByEvent(event)">${this.t('edit')}</button>
                                <button class="danger" data-difficulty="${difficulty}" data-index="${idx}" onclick="app.deleteProblemByEvent(event)">${this.t('delete')}</button>
                            </div>
                        </div>
                    `).join('');
                    
                    const customSection = `
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--accent); margin-bottom: 10px; font-size: 16px;">âœï¸ ã‚«ã‚¹ã‚¿ãƒ å•é¡Œ (${customProblems.length}ä»¶)</h4>
                            ${customProblems.length > 0 ? customProblemsHTML : `<p style="text-align: center; padding: 20px; opacity: 0.6;">${this.t('noCustomProblems')}</p>`}
                            <button style="margin-top: 10px; width: 100%;" data-difficulty="${difficulty}" onclick="app.showAddProblemDialogByEvent(event)">â• ${this.t('addProblem')}</button>
                        </div>
                    `;
                    
                    return `
                        <div class="tab-content ${index === 0 ? 'active' : ''}" id="tab-${difficulty}">
                            <div style="padding: 10px 0;">
                                <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 5px;">
                                    <strong>åˆè¨ˆ: ${defaultProblems.length + customProblems.length}ä»¶</strong>
                                    <span style="opacity: 0.7; margin-left: 10px;">(æ—¢å­˜: ${defaultProblems.length}ä»¶ / ã‚«ã‚¹ã‚¿ãƒ : ${customProblems.length}ä»¶)</span>
                                </div>
                                ${defaultProblemsHTML}
                                ${customSection}
                            </div>
                        </div>
                    `;
                }).join('');

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
                        <h2>${this.t('customProblemsTitle')}</h2>
                        
                        <div class="tabs">
                            <button class="tab active" onclick="app.switchTab('beginner')">${this.t('beginner')}</button>
                            <button class="tab" onclick="app.switchTab('intermediate')">${this.t('intermediate')}</button>
                            <button class="tab" onclick="app.switchTab('advanced')">${this.t('advanced')}</button>
                        </div>
                        
                        <div style="max-height: 50vh; overflow-y: auto;">
                            ${tabContents}
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid var(--border);">
                            <button onclick="app.exportCustomProblems()">ğŸ“¤ ${this.t('exportProblems')}</button>
                            <button onclick="app.importCustomProblems()">ğŸ“¥ ${this.t('importProblems')}</button>
                            <button class="secondary" onclick="app.closeModal(this)">${this.t('close')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
            }

            switchTab(difficulty) {
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                event.target.classList.add('active');
                document.getElementById(`tab-${difficulty}`).classList.add('active');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showAddProblemDialogByEvent(event) {
                const difficulty = event.target.dataset.difficulty;
                this.showAddProblemDialog(difficulty);
            }

            editProblemByEvent(event) {
                const difficulty = event.target.dataset.difficulty;
                const index = parseInt(event.target.dataset.index);
                this.editProblem(difficulty, index);
            }

            deleteProblemByEvent(event) {
                const difficulty = event.target.dataset.difficulty;
                const index = parseInt(event.target.dataset.index);
                this.deleteProblem(difficulty, index);
            }

            showAddProblemDialog(difficulty) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <h2>${this.t('addProblem')}</h2>
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">${this.t('problemText')}</label>
                            <input type="text" id="problemInput" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 5px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;" placeholder="${this.t('problemText')}">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button data-difficulty="${difficulty}" onclick="app.addCustomProblemByEvent(event)">${this.t('add')}</button>
                            <button class="secondary" onclick="app.closeModal(this)">${this.t('cancel')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
                setTimeout(() => document.getElementById('problemInput').focus(), 100);
            }

            addCustomProblemByEvent(event) {
                const difficulty = event.target.dataset.difficulty;
                this.addCustomProblem(difficulty);
            }

            editProblem(difficulty, index) {
                const problem = this.customProblems[difficulty][index];
                const escapedProblem = problem.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <h2>${this.t('edit')}</h2>
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">${this.t('problemText')}</label>
                            <input type="text" id="problemInput" value="${escapedProblem}" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 5px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button data-difficulty="${difficulty}" data-index="${index}" onclick="app.updateCustomProblemByEvent(event)">${this.t('save')}</button>
                            <button class="secondary" onclick="app.closeModal(this)">${this.t('cancel')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
                setTimeout(() => document.getElementById('problemInput').focus(), 100);
            }

            updateCustomProblemByEvent(event) {
                const difficulty = event.target.dataset.difficulty;
                const index = parseInt(event.target.dataset.index);
                this.updateCustomProblem(difficulty, index);
            }

            addCustomProblem(difficulty) {
                const input = document.getElementById('problemInput');
                const text = input.value.trim();
                
                if (!text) {
                    alert(this.t('noProblemText'));
                    return;
                }
                
                if (!this.customProblems[difficulty]) {
                    this.customProblems[difficulty] = [];
                }
                
                this.customProblems[difficulty].push(text);
                this.saveCustomProblems();
                this.showMessage(this.t('problemAdded'));
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦è¨­å®šç”»é¢ã‚’å†è¡¨ç¤º
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => modal.remove());
                this.showSettings();
                // å•é¡Œç®¡ç†ã‚¿ãƒ–ã‚’é–‹ã
                setTimeout(() => {
                    const problemTab = document.querySelector('.tabs button:nth-child(2)');
                    if (problemTab) problemTab.click();
                    // è©²å½“ã™ã‚‹é›£æ˜“åº¦ã‚¿ãƒ–ã‚’é–‹ã
                    setTimeout(() => {
                        const difficultyTabs = document.querySelectorAll('#settings-tab-problems .tabs button');
                        const difficultyIndex = ['beginner', 'intermediate', 'advanced'].indexOf(difficulty);
                        if (difficultyTabs[difficultyIndex]) difficultyTabs[difficultyIndex].click();
                    }, 50);
                }, 50);
            }

            updateCustomProblem(difficulty, index) {
                const input = document.getElementById('problemInput');
                const text = input.value.trim();
                
                if (!text) {
                    alert(this.t('noProblemText'));
                    return;
                }
                
                this.customProblems[difficulty][index] = text;
                this.saveCustomProblems();
                this.showMessage(this.t('problemUpdated'));
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦è¨­å®šç”»é¢ã‚’å†è¡¨ç¤º
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => modal.remove());
                this.showSettings();
                // å•é¡Œç®¡ç†ã‚¿ãƒ–ã‚’é–‹ã
                setTimeout(() => {
                    const problemTab = document.querySelector('.tabs button:nth-child(2)');
                    if (problemTab) problemTab.click();
                    // è©²å½“ã™ã‚‹é›£æ˜“åº¦ã‚¿ãƒ–ã‚’é–‹ã
                    setTimeout(() => {
                        const difficultyTabs = document.querySelectorAll('#settings-tab-problems .tabs button');
                        const difficultyIndex = ['beginner', 'intermediate', 'advanced'].indexOf(difficulty);
                        if (difficultyTabs[difficultyIndex]) difficultyTabs[difficultyIndex].click();
                    }, 50);
                }, 50);
            }

            deleteProblem(difficulty, index) {
                if (confirm(this.t('confirmDeleteProblem'))) {
                    this.customProblems[difficulty].splice(index, 1);
                    this.saveCustomProblems();
                    
                    // ã‚«ã‚¹ã‚¿ãƒ å•é¡ŒãŒã™ã¹ã¦ãªããªã£ãŸå ´åˆã€è¨­å®šã‚’å¤‰æ›´
                    const hasCustomProblems = 
                        (this.customProblems.beginner && this.customProblems.beginner.length > 0) ||
                        (this.customProblems.intermediate && this.customProblems.intermediate.length > 0) ||
                        (this.customProblems.advanced && this.customProblems.advanced.length > 0);
                    
                    if (!hasCustomProblems && this.problemSource === 'custom') {
                        this.problemSource = 'both';
                        this.saveSettings();
                        this.showMessage(this.t('problemDeletedAndSourceChanged'));
                    } else {
                        this.showMessage(this.t('problemDeleted'));
                    }
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦è¨­å®šç”»é¢ã‚’å†è¡¨ç¤º
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());
                    this.showSettings();
                    // å•é¡Œç®¡ç†ã‚¿ãƒ–ã‚’é–‹ã
                    setTimeout(() => {
                        const problemTab = document.querySelector('.tabs button:nth-child(2)');
                        if (problemTab) problemTab.click();
                        // è©²å½“ã™ã‚‹é›£æ˜“åº¦ã‚¿ãƒ–ã‚’é–‹ã
                        setTimeout(() => {
                            const difficultyTabs = document.querySelectorAll('#settings-tab-problems .tabs button');
                            const difficultyIndex = ['beginner', 'intermediate', 'advanced'].indexOf(difficulty);
                            if (difficultyTabs[difficultyIndex]) difficultyTabs[difficultyIndex].click();
                        }, 50);
                    }, 50);
                }
            }

            exportCustomProblems() {
                const data = {
                    version: '1.0',
                    problems: this.customProblems,
                    exportedAt: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `typing-problems-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showMessage(this.t('problemsExported'));
            }

            importCustomProblems() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (data.problems) {
                                // ãƒãƒ¼ã‚¸ï¼ˆæ—¢å­˜ã®å•é¡Œã‚’ä¿æŒã—ã¤ã¤æ–°ã—ã„å•é¡Œã‚’è¿½åŠ ï¼‰
                                ['beginner', 'intermediate', 'advanced'].forEach(difficulty => {
                                    if (data.problems[difficulty]) {
                                        if (!this.customProblems[difficulty]) {
                                            this.customProblems[difficulty] = [];
                                        }
                                        // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚
                                        data.problems[difficulty].forEach(problem => {
                                            if (!this.customProblems[difficulty].includes(problem)) {
                                                this.customProblems[difficulty].push(problem);
                                            }
                                        });
                                    }
                                });
                                
                                this.saveCustomProblems();
                                this.showMessage(this.t('problemsImported'));
                                
                                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦å†è¡¨ç¤º
                                const modals = document.querySelectorAll('.modal');
                                modals.forEach(modal => modal.remove());
                                this.showCustomProblems();
                            } else {
                                alert(this.t('invalidFile'));
                            }
                        } catch (error) {
                            alert(this.t('invalidFile'));
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            saveCustomProblems() {
                localStorage.setItem('typingTrainerCustomProblems', JSON.stringify(this.customProblems));
            }

            loadCustomProblems() {
                const saved = localStorage.getItem('typingTrainerCustomProblems');
                if (saved) {
                    try {
                        this.customProblems = JSON.parse(saved);
                    } catch (error) {
                        this.customProblems = { beginner: [], intermediate: [], advanced: [] };
                    }
                }
            }

            // ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰
            showRelaxMode() {
                // ãƒˆã‚°ãƒ«æ©Ÿèƒ½ï¼šæ—¢ã«ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã‚ªãƒ•ã«ã™ã‚‹
                if (this.isRelaxMode) {
                    this.exitRelaxMode();
                    return;
                }
                
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãŒé€²è¡Œä¸­ã®å ´åˆã¯ä¸­æ–­
                if (this.isPlaying) {
                    this.resetPractice();
                }
                
                // ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                this.isRelaxMode = true;
                document.body.classList.add('relax-mode');
                
                // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’éè¡¨ç¤ºï¼ˆCSSã¨JavaScriptä¸¡æ–¹ã§ç¢ºå®Ÿã«ï¼‰
                const statsBar = document.getElementById('statsBar');
                if (statsBar) {
                    statsBar.style.display = 'none';
                    statsBar.classList.add('hidden');
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤º
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.display = 'none';
                }
                
                // ä¸€æ™‚åœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const resetBtn = document.getElementById('resetBtn');
                const startBtn = document.getElementById('startBtn');
                if (pauseBtn) pauseBtn.style.display = 'none';
                if (resumeBtn) resumeBtn.style.display = 'none';
                if (resetBtn) resetBtn.style.display = 'none';
                if (startBtn) startBtn.style.display = 'none';
                
                // Canvasè¿½åŠ ï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢å†…ã«é…ç½®ï¼‰
                const typingArea = document.getElementById('typingArea');
                typingArea.style.position = 'relative';
                
                // æ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å‰Šé™¤
                const existingCanvas = document.getElementById('relaxCanvas');
                if (existingCanvas) {
                    existingCanvas.remove();
                }
                
                const canvas = document.createElement('canvas');
                canvas.id = 'relaxCanvas';
                canvas.className = 'relax-canvas';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.pointerEvents = 'none';
                canvas.style.zIndex = '1';
                typingArea.insertBefore(canvas, typingArea.firstChild);
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒç¢ºå®šã—ã¦ã‹ã‚‰ï¼‰
                setTimeout(() => {
                    canvas.width = typingArea.offsetWidth;
                    canvas.height = typingArea.offsetHeight;
                    console.log('Canvas size:', canvas.width, 'x', canvas.height);
                }, 10);
                
                this.relaxCanvas = canvas;
                this.relaxCtx = canvas.getContext('2d');

                // ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 
                this.graphics = [];

                // å…¥åŠ›ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹ç”¨ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹
                this.relaxKeyCount = 0; // ç´¯ç©å…¥åŠ›æ•°
                this.relaxKeyTimes = []; // ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»ï¼ˆmsï¼‰

                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ Canvas ã‚’è¿½åŠ ï¼ˆç”»é¢å…¨ä½“ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰
                const existingGlobal = document.getElementById('relaxGlobalCanvas');
                if (existingGlobal) existingGlobal.remove();
                const globalCanvas = document.createElement('canvas');
                globalCanvas.id = 'relaxGlobalCanvas';
                globalCanvas.style.position = 'fixed';
                globalCanvas.style.top = '0';
                globalCanvas.style.left = '0';
                globalCanvas.style.width = '100%';
                globalCanvas.style.height = '100%';
                globalCanvas.style.pointerEvents = 'none';
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„ãƒˆãƒ¼ã‚¹ãƒˆ(1000)ã‚ˆã‚Šä¸‹ã€é€šå¸¸UIã‚ˆã‚Šä¸Š
                globalCanvas.style.zIndex = '500';
                document.body.appendChild(globalCanvas);
                // å®Ÿãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºè¨­å®š
                const setGlobalSize = () => {
                    globalCanvas.width = window.innerWidth;
                    globalCanvas.height = window.innerHeight;
                };
                setGlobalSize();
                this.globalCanvas = globalCanvas;
                this.globalCtx = globalCanvas.getContext('2d');

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®é…åˆ—
                this.globalParticles = [];
                this.globalRipples = [];
                
                // ä½¿ç”¨å¯èƒ½ãªã‚­ãƒ¼ãƒªã‚¹ãƒˆï¼ˆa-zã¾ã§ï¼‰
                this.relaxKeys = 'abcdefghijklmnopqrstuvwxyz';
                
                // UIæ›´æ–°
                this.updateRelaxUI();
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
                this.animateRelax();
                
                // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
                this.resizeHandler = () => {
                    if (this.isRelaxMode && this.relaxCanvas) {
                        const typingArea = document.getElementById('typingArea');
                        this.relaxCanvas.width = typingArea.offsetWidth;
                        this.relaxCanvas.height = typingArea.offsetHeight;
                    }
                    if (this.isRelaxMode && this.globalCanvas) {
                        this.globalCanvas.width = window.innerWidth;
                        this.globalCanvas.height = window.innerHeight;
                    }
                };
                window.addEventListener('resize', this.resizeHandler);
                
                // éŠã³ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
                const relaxBtn = document.getElementById('relaxBtn');
                if (relaxBtn && relaxBtn.parentElement) {
                    relaxBtn.parentElement.style.background = '#FF6B6B';
                }
            }

            updateRelaxUI() {
                const textDisplay = document.getElementById('textDisplay');
                // ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã¯èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
                // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒã®ãŸã‚ã€ç©ºã«ã—ã¦ãŠã
                textDisplay.innerHTML = '';
            }

            handleKeyPress(e) {
                // ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
                if (this.isRelaxMode) {
                    const key = e.key.toLowerCase();
                    
                    // ä¿®é£¾ã‚­ãƒ¼ã¯ç„¡è¦–
                    const modifierKeys = ['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab', 'Escape', 'Enter', 'Backspace'];
                    if (modifierKeys.includes(e.key)) {
                        return;
                    }
                    
                    // a-zã®ã‚­ãƒ¼ã®ã¿å‡¦ç†
                    if (/^[a-z]$/.test(key)) {
                        // éŸ³ã‚’å†ç”Ÿ
                        this.audioSystem.playSound(key);

                        // ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”Ÿæˆ
                        this.createGraphic(key);

                        // å…¥åŠ›ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°ï¼ˆç›´è¿‘2ç§’ã®ã‚­ãƒ¼æ•°ï¼é€Ÿåº¦ç›®å®‰ï¼‰
                        const now = Date.now();
                        this.relaxKeyCount += 1;
                        this.relaxKeyTimes.push(now);
                        // 2ç§’ã‚ˆã‚Šå¤ã„ã‚‚ã®ã‚’å‰Šé™¤
                        const cutoff = now - 2000;
                        this.relaxKeyTimes = this.relaxKeyTimes.filter(t => t >= cutoff);
                        const kps = this.relaxKeyTimes.length / 2; // keys per second
                        // é€Ÿåº¦ã«å¿œã˜ãŸå¼·åº¦(0.0-1.0)ã‚’ç®—å‡ºï¼ˆæœ€å¤§ ~8kps ã§1.0ï¼‰
                        const speedIntensity = Math.max(0, Math.min(1, kps / 8));
                        // ç´¯ç©å…¥åŠ›ã«å¿œã˜ãŸãƒ™ãƒ¼ã‚¹å¼·åº¦ï¼ˆä¸Šé™1.0ï¼‰
                        const amountIntensity = Math.max(0, Math.min(1, this.relaxKeyCount / 200));
                        // åˆæˆå¼·åº¦
                        const intensity = Math.max(speedIntensity, amountIntensity);

                        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºç«
                        this.spawnEdgeStreak(intensity);
                        if (Math.random() < 0.3 + intensity * 0.4) {
                            this.spawnGlobalRipple(intensity);
                        }

                        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        this.highlightKey(key, true);
                        setTimeout(() => this.highlightKey(key, false), 200);
                    }
                    return;
                }
                
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚²ãƒ¼ãƒ æœªé–‹å§‹æ™‚ï¼‰
                if (!this.isPlaying && e.key === ' ') {
                    e.preventDefault();
                    this.startPractice();
                    return;
                }
                
                if (!this.isPlaying || this.isPaused) return;
                
                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¸¸ã«é˜²æ­¢
                if (e.key === ' ') {
                    e.preventDefault();
                }
                
                const key = e.key;
                
                // ä¿®é£¾ã‚­ãƒ¼ï¼ˆShift, Ctrl, Alt, Metaç­‰ï¼‰ã¯ç„¡è¦–
                const modifierKeys = ['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab', 'Escape', 'Enter', 'Backspace'];
                if (modifierKeys.includes(key)) {
                    return;
                }
                
                // éŸ³ã‚’å†ç”Ÿ
                this.audioSystem.playSound(key);
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’æ›´æ–°
                this.highlightKey(key, true);
                
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
                const expectedChar = this.currentText[this.currentIndex];
                
                if (key === expectedChar) {
                    this.correctCount++;
                    this.markCharacter(this.currentIndex, 'correct');
                    this.currentIndex++;
                    
                    if (this.currentIndex >= this.currentText.length) {
                        this.nextProblem();
                    } else {
                        this.updateCurrentCharacter();
                    }
                } else {
                    // ãƒŸã‚¹ã—ãŸå ´åˆã¯èµ¤å­—è¡¨ç¤ºã®ã¿ã§ã€æŠ¼ã—ç›´ã—ãŒå¿…è¦
                    this.incorrectCount++;
                    this.markCharacter(this.currentIndex, 'incorrect');
                    
                    // æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
                    this.highlightKey(key, true, true);
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰èµ¤å­—ã‚’è§£é™¤ã—ã¦å†åº¦currentã«æˆ»ã™
                    setTimeout(() => {
                        this.markCharacter(this.currentIndex, 'reset');
                        this.updateCurrentCharacter();
                        this.highlightKey(key, false, true);
                    }, 300);
                }
                
                // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ç™ºç”Ÿï¼‰
                // ã‚­ãƒ¼ãŒå˜ä¸€æ–‡å­—ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ç­‰ã¯é™¤ãï¼‰ãªã‚‰ç™ºç«
                if (/^.$/.test(key) && key.length === 1) {
                    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ã®å¹¾ä½•å­¦æ¨¡æ§˜
                    if (this.relaxCanvas && this.relaxCtx) {
                        this.createGraphic(key.toLowerCase());
                    }
                    // å…¥åŠ›ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
                    const now = Date.now();
                    this.relaxKeyCount = (this.relaxKeyCount || 0) + 1;
                    this.relaxKeyTimes = (this.relaxKeyTimes || []);
                    this.relaxKeyTimes.push(now);
                    const cutoff = now - 2000;
                    this.relaxKeyTimes = this.relaxKeyTimes.filter(t => t >= cutoff);
                    const kps = this.relaxKeyTimes.length / 2;
                    const speedIntensity = Math.max(0, Math.min(1, kps / 8));
                    const amountIntensity = Math.max(0, Math.min(1, (this.relaxKeyCount || 0) / 200));
                    const intensity = Math.max(speedIntensity, amountIntensity);
                    // å…¨ç”»é¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    if (this.globalCanvas && this.globalCtx) {
                        this.spawnEdgeStreak(intensity);
                        if (Math.random() < 0.3 + intensity * 0.4) {
                            this.spawnGlobalRipple(intensity);
                        }
                    }
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ãŒåœæ­¢ã—ã¦ã„ãŸã‚‰å†é–‹
                    if (!this._visualsAnimating) {
                        this._visualsAnimating = true;
                        this.animateRelax();
                    }
                }

                this.updateStats();
            }

            createGraphic(key) {
                if (!this.relaxCanvas || !this.relaxCtx) {
                    console.error('Canvas not initialized');
                    return;
                }
                
                const canvas = this.relaxCanvas;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºãŒ0ã®å ´åˆã¯å†è¨­å®š
                if (canvas.width === 0 || canvas.height === 0) {
                    const typingArea = document.getElementById('typingArea');
                    canvas.width = typingArea.offsetWidth;
                    canvas.height = typingArea.offsetHeight;
                }
                
                // ã‚­ãƒ¼ã«å¿œã˜ãŸè‰²ã¨ã‚·ã‚§ã‚¤ãƒ—
                const shapes = [
                    'circle', 'polygon', 'star', 'spiral', 'burst', 'wave'
                ];
                const keyCode = key.charCodeAt(0);
                const shapeType = shapes[keyCode % shapes.length];
                const hue = (keyCode * 30) % 360;
                
                this.graphics.push({
                    x: centerX,
                    y: centerY,
                    type: shapeType,
                    hue: hue,
                    scale: 0,
                    rotation: 0,
                    life: 1.0,
                    maxScale: 100 + Math.random() * 80
                });
                
                console.log('Graphic created:', shapeType, 'at', centerX, centerY, 'hue', hue);
            }

            animateRelax() {
                // ã„ãšã‚Œã‹ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒãªã‘ã‚Œã°åœæ­¢
                if (!((this.relaxCtx && this.relaxCanvas) || (this.globalCtx && this.globalCanvas))) {
                    this._visualsAnimating = false;
                    return;
                }

                const ctx = this.relaxCtx;
                const canvas = this.relaxCanvas;
                
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢å†…ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æç”»
                if (ctx && canvas) {
                    // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢ï¼ˆå®Œå…¨é€æ˜ - ã‚µã‚¤ãƒˆã®èƒŒæ™¯ã‚’è¦‹ã›ã‚‹ï¼‰
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ›´æ–°ãƒ»æç”»
                    this.graphics = this.graphics.filter(g => {
                        g.scale += (g.maxScale - g.scale) * 0.15;
                        g.rotation += 0.05;
                        g.life -= 0.012;
                        
                        if (g.life > 0) {
                            ctx.save();
                            ctx.translate(g.x, g.y);
                            ctx.rotate(g.rotation);
                            ctx.globalAlpha = g.life;
                            
                            this.drawShape(ctx, g);
                            
                            ctx.restore();
                            return true;
                        }
                        return false;
                    });
                }

                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æç”»
                if (this.globalCtx && this.globalCanvas) {
                    const gctx = this.globalCtx;
                    const gcan = this.globalCanvas;
                    // é€æ˜ã‚¯ãƒªã‚¢
                    gctx.clearRect(0, 0, gcan.width, gcan.height);

                    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ›´æ–°ãƒ»æç”»
                    this.globalParticles = this.globalParticles.filter(p => {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.life -= 0.015;
                        p.size += p.grow;
                        p.vx *= 0.99;
                        p.vy *= 0.99;
                        if (p.life > 0) {
                            gctx.save();
                            gctx.globalAlpha = Math.max(0, p.life) * 0.8;
                            const color = `hsla(${p.hue}, 80%, ${p.lightness}%, ${Math.max(0, p.life)})`;
                            gctx.fillStyle = color;
                            gctx.beginPath();
                            gctx.arc(p.x, p.y, Math.max(0.5, p.size), 0, Math.PI * 2);
                            gctx.fill();
                            gctx.restore();
                            return true;
                        }
                        return false;
                    });

                    // ãƒªãƒƒãƒ—ãƒ«æ›´æ–°ãƒ»æç”»
                    this.globalRipples = this.globalRipples.filter(r => {
                        r.radius += r.growth;
                        r.life -= 0.01;
                        if (r.life > 0) {
                            gctx.save();
                            gctx.beginPath();
                            gctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
                            gctx.strokeStyle = `hsla(${r.hue}, 70%, 60%, ${Math.max(0, r.life)})`;
                            gctx.lineWidth = 2 + r.growth * 0.3;
                            gctx.stroke();
                            gctx.restore();
                            return true;
                        }
                        return false;
                    });
                }

                requestAnimationFrame(() => this.animateRelax());
            }

            // ç”»é¢ç«¯ã‹ã‚‰å†…å´ã«æµå…¥ã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ç”Ÿæˆï¼ˆé€Ÿåº¦ãƒ»é‡ã«å¿œã˜ã¦ï¼‰
            spawnEdgeStreak(intensity = 0.3) {
                if (!this.globalCanvas) return;
                const w = this.globalCanvas.width;
                const h = this.globalCanvas.height;
                const side = Math.floor(Math.random() * 4); // 0:top 1:right 2:bottom 3:left
                const count = Math.floor(8 + intensity * 24);
                const baseHue = Math.floor((Date.now() / 40) % 360);
                for (let i = 0; i < count; i++) {
                    let x = 0, y = 0, vx = 0, vy = 0;
                    const spread = 0.8 + Math.random() * 0.6;
                    switch (side) {
                        case 0: // top
                            x = Math.random() * w;
                            y = -10;
                            vx = (Math.random() - 0.5) * 2 * spread;
                            vy = 1.5 + Math.random() * 3 * (0.5 + intensity);
                            break;
                        case 1: // right
                            x = w + 10;
                            y = Math.random() * h;
                            vx = - (1.5 + Math.random() * 3 * (0.5 + intensity));
                            vy = (Math.random() - 0.5) * 2 * spread;
                            break;
                        case 2: // bottom
                            x = Math.random() * w;
                            y = h + 10;
                            vx = (Math.random() - 0.5) * 2 * spread;
                            vy = - (1.5 + Math.random() * 3 * (0.5 + intensity));
                            break;
                        case 3: // left
                            x = -10;
                            y = Math.random() * h;
                            vx = 1.5 + Math.random() * 3 * (0.5 + intensity);
                            vy = (Math.random() - 0.5) * 2 * spread;
                            break;
                    }
                    const hue = (baseHue + i * 7) % 360;
                    this.globalParticles.push({
                        x, y, vx, vy,
                        life: 0.9 + Math.random() * 0.6,
                        size: 1 + Math.random() * (3 + intensity * 4),
                        grow: 0.02 + Math.random() * 0.04,
                        hue,
                        lightness: 55 + Math.random() * 20
                    });
                }
            }

            // ç”»é¢å…¨ä½“ã®ãƒªãƒƒãƒ—ãƒ«ï¼ˆã‚†ã£ãã‚ŠåºƒãŒã‚‹å††ï¼‰
            spawnGlobalRipple(intensity = 0.3) {
                if (!this.globalCanvas) return;
                const w = this.globalCanvas.width;
                const h = this.globalCanvas.height;
                // ç«¯å¯„ã‚Šã¾ãŸã¯ä¸­å¤®ä»˜è¿‘ã«ç™ºç”Ÿ
                const edgeBias = Math.random();
                let x = Math.random() * w;
                let y = Math.random() * h;
                if (edgeBias < 0.5) {
                    const side = Math.floor(Math.random() * 4);
                    if (side === 0) { y = h * 0.1; }
                    if (side === 1) { x = w * 0.9; }
                    if (side === 2) { y = h * 0.9; }
                    if (side === 3) { x = w * 0.1; }
                }
                const baseRadius = 20 + intensity * 60;
                const growth = 1.5 + intensity * 3;
                const hue = Math.floor((Date.now() / 30) % 360);
                this.globalRipples.push({
                    x, y,
                    radius: baseRadius,
                    growth,
                    life: 0.8 + Math.random() * 0.4,
                    hue
                });
            }

            drawShape(ctx, g) {
                const color = `hsl(${g.hue}, 70%, 60%)`;
                
                switch (g.type) {
                    case 'circle':
                        ctx.beginPath();
                        ctx.arc(0, 0, g.scale, 0, Math.PI * 2);
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                        
                    case 'polygon':
                        ctx.beginPath();
                        const sides = 6;
                        for (let i = 0; i <= sides; i++) {
                            const angle = (Math.PI * 2 * i) / sides;
                            const x = Math.cos(angle) * g.scale;
                            const y = Math.sin(angle) * g.scale;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                        
                    case 'star':
                        ctx.beginPath();
                        for (let i = 0; i < 10; i++) {
                            const angle = (Math.PI * 2 * i) / 10;
                            const radius = i % 2 === 0 ? g.scale : g.scale * 0.5;
                            const x = Math.cos(angle) * radius;
                            const y = Math.sin(angle) * radius;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                        
                    case 'spiral':
                        ctx.beginPath();
                        for (let i = 0; i < 100; i++) {
                            const angle = (Math.PI * 6 * i) / 100;
                            const radius = (g.scale * i) / 100;
                            const x = Math.cos(angle) * radius;
                            const y = Math.sin(angle) * radius;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                        
                    case 'burst':
                        for (let i = 0; i < 12; i++) {
                            const angle = (Math.PI * 2 * i) / 12;
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(Math.cos(angle) * g.scale, Math.sin(angle) * g.scale);
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                        break;
                        
                    case 'wave':
                        ctx.beginPath();
                        for (let i = -50; i <= 50; i++) {
                            const x = i * 4;
                            const y = Math.sin((i + g.rotation * 20) * 0.2) * g.scale * 0.3;
                            if (i === -50) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                }
            }

            exitRelaxMode() {
                this.isRelaxMode = false;
                document.body.classList.remove('relax-mode');
                
                // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’å¾©å…ƒ
                const statsBar = document.getElementById('statsBar');
                if (statsBar) {
                    statsBar.style.display = '';
                    statsBar.classList.remove('hidden');
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’å¾©å…ƒ
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.display = '';
                }
                
                // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å¾©å…ƒ
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const resetBtn = document.getElementById('resetBtn');
                const startBtn = document.getElementById('startBtn');
                
                // ã¾ãšstyle.displayã‚’ãƒªã‚»ãƒƒãƒˆ
                if (pauseBtn) pauseBtn.style.display = '';
                if (resumeBtn) resumeBtn.style.display = '';
                if (resetBtn) resetBtn.style.display = '';
                if (startBtn) startBtn.style.display = '';
                
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã«å¿œã˜ã¦hiddenã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡
                if (this.isPlaying) {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰é€²è¡Œä¸­ã®å ´åˆ
                    if (startBtn) startBtn.classList.add('hidden');
                    if (this.isPaused) {
                        if (pauseBtn) pauseBtn.classList.add('hidden');
                        if (resumeBtn) resumeBtn.classList.remove('hidden');
                    } else {
                        if (pauseBtn) pauseBtn.classList.remove('hidden');
                        if (resumeBtn) resumeBtn.classList.add('hidden');
                    }
                    if (resetBtn) resetBtn.classList.remove('hidden');
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æœªé–‹å§‹ã®å ´åˆ
                    if (startBtn) startBtn.classList.remove('hidden');
                    if (pauseBtn) pauseBtn.classList.add('hidden');
                    if (resumeBtn) resumeBtn.classList.add('hidden');
                    if (resetBtn) resetBtn.classList.add('hidden');
                }
                
                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºã«ã—ãŸã„ã®ã§å‰Šé™¤
                const areaCanvas = document.getElementById('relaxCanvas');
                if (areaCanvas) {
                    areaCanvas.remove();
                }
                this.relaxCanvas = null;
                this.relaxCtx = null;
                
                // ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ
                this.graphics = [];
                this.globalParticles = [];
                this.globalRipples = [];
                
                // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰Šé™¤
                if (this.resizeHandler) {
                    window.removeEventListener('resize', this.resizeHandler);
                    this.resizeHandler = null;
                }
                
                // éŠã³ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                const relaxBtn = document.getElementById('relaxBtn');
                if (relaxBtn && relaxBtn.parentElement) {
                    relaxBtn.parentElement.style.background = '';
                }
                
                // UIå¾©å…ƒ
                if (!this.isPlaying) {
                    document.getElementById('textDisplay').innerHTML = this.t('startMessage');
                }
            }

            showGuide() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2>${this.t('guideTitle')}</h2>
                        <div class="guide-content">
                            <div class="guide-section">
                                <h3>${this.t('aboutTitle')}</h3>
                                <p>${this.t('aboutText')}</p>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('howToTitle')}</h3>
                                <ol style="margin-left: 20px; line-height: 2;">
                                    <li><span class="keyboard-hint">${this.t('start')}</span> ${this.t('howToStep1')}</li>
                                    <li>${this.t('howToStep2')}</li>
                                    <li>${this.t('howToStep3')}</li>
                                    <li>${this.t('howToStep4')}</li>
                                    <li>${this.t('howToStep5')}</li>
                                </ol>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('statsTitle')}</h3>
                                
                                <div class="stat-explanation">
                                    <strong>${this.t('progress')}</strong>
                                    <p>${this.t('progressDesc')}</p>
                                </div>

                                <div class="stat-explanation">
                                    <strong>WPM (Words Per Minute)</strong>
                                    <p>${this.t('wpmDesc')}<br>
                                    ${this.t('wpmNote')}</p>
                                    <ul style="margin-top: 10px;">
                                        <li>${this.t('wpmLevel1')}</li>
                                        <li>${this.t('wpmLevel2')}</li>
                                        <li>${this.t('wpmLevel3')}</li>
                                        <li>${this.t('wpmLevel4')}</li>
                                    </ul>
                                </div>

                                <div class="stat-explanation">
                                    <strong>${this.t('accuracyRate')}</strong>
                                    <p>${this.t('accuracyDesc')}</p>
                                    <ul style="margin-top: 10px;">
                                        <li>${this.t('accuracyLevel1')}</li>
                                        <li>${this.t('accuracyLevel2')}</li>
                                        <li>${this.t('accuracyLevel3')}</li>
                                        <li>${this.t('accuracyLevel4')}</li>
                                    </ul>
                                </div>

                                <div class="stat-explanation">
                                    <strong>${this.t('time')}</strong>
                                    <p>${this.t('timeDesc')}</p>
                                </div>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('rankTitle')}</h3>
                                <p>${this.t('rankDesc')}</p>
                                <ul style="margin-left: 20px;">
                                    <li><strong style="color: #FFD700;">${this.t('rankS')}</strong></li>
                                    <li><strong style="color: #4CAF50;">${this.t('rankA')}</strong></li>
                                    <li><strong style="color: #2196F3;">${this.t('rankB')}</strong></li>
                                    <li><strong style="color: #FF9800;">${this.t('rankC')}</strong></li>
                                    <li><strong style="color: #f44336;">${this.t('rankD')}</strong></li>
                                </ul>
                                <p style="margin-top: 15px;">${this.t('scoreFormula')}</p>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('soundTitle')}</h3>
                                <div class="feature-list">
                                    <div class="feature-item">
                                        <h4>ğŸ¹ ${this.t('piano')}</h4>
                                        <p>${this.t('pianoDesc')}</p>
                                    </div>
                                    <div class="feature-item">
                                        <h4>ğŸ¥ ${this.t('drum')}</h4>
                                        <p>${this.t('drumDesc')}</p>
                                    </div>
                                    <div class="feature-item">
                                        <h4>ğŸ›ï¸ ${this.t('synth')}</h4>
                                        <p>${this.t('synthDesc')}</p>
                                    </div>
                                    <div class="feature-item">
                                        <h4>ğŸŒŠ ${this.t('ambient')}</h4>
                                        <p>${this.t('ambientDesc')}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('customizeTitle')}</h3>
                                <p>${this.t('customizeDesc')}</p>
                                <ul style="margin-left: 20px;">
                                    <li>${this.t('customizeItem1')}</li>
                                    <li>${this.t('customizeItem2')}</li>
                                    <li>${this.t('customizeItem3')}</li>
                                    <li>${this.t('customizeItem4')}</li>
                                    <li>${this.t('customizeItem5')}</li>
                                    <li>${this.t('customizeItem6')}</li>
                                </ul>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('tipsTitle')}</h3>
                                <ul style="margin-left: 20px;">
                                    <li>${this.t('tip1')}</li>
                                    <li>${this.t('tip2')}</li>
                                    <li>${this.t('tip3')}</li>
                                    <li>${this.t('tip4')}</li>
                                    <li>${this.t('tip5')}</li>
                                </ul>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('visualTitle')}</h3>
                                <ul style="margin-left: 20px;">
                                    <li>${this.t('visualItem1')}</li>
                                    <li>${this.t('visualItem2')}</li>
                                    <li>${this.t('visualItem3')}</li>
                                    <li>${this.t('visualItem4')}</li>
                                    <li>${this.t('visualItem5')}</li>
                                </ul>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('historyFeatureTitle')}</h3>
                                <p>${this.t('historyFeatureDesc')}</p>
                                <ul style="margin-left: 20px;">
                                    <li>${this.t('historyItem1')}</li>
                                    <li>${this.t('historyItem2')}</li>
                                    <li>${this.t('historyItem3')}</li>
                                    <li>${this.t('historyItem4')}</li>
                                    <li>${this.t('historyItem5')}</li>
                                </ul>
                                <p style="margin-top: 10px;">${this.t('historyNote')}</p>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('dataTitle')}</h3>
                                <p>${this.t('dataDesc')}</p>
                                <ul style="margin-left: 20px;">
                                    <li>${this.t('dataItem1')}</li>
                                    <li>${this.t('dataItem2')}</li>
                                    <li>${this.t('dataItem3')}</li>
                                </ul>
                            </div>

                            <div class="guide-section">
                                <h3>${this.t('shortcutTitle')}</h3>
                                <ul style="margin-left: 20px;">
                                    <li><span class="keyboard-hint">SPACE</span>${this.t('shortcutItem1')}</li>
                                    <li><span class="keyboard-hint">Shift</span>${this.t('shortcutItem2')}</li>
                                </ul>
                                <p style="margin-top: 10px;"><em>${this.t('shortcutNote')}</em></p>
                            </div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="app.closeModal(this)">${this.t('close')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
            }

            showSettings() {
                // ã‚«ã‚¹ã‚¿ãƒ å•é¡ŒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasCustomProblems = 
                    (this.customProblems.beginner && this.customProblems.beginner.length > 0) ||
                    (this.customProblems.intermediate && this.customProblems.intermediate.length > 0) ||
                    (this.customProblems.advanced && this.customProblems.advanced.length > 0);
                
                // ã‚«ã‚¹ã‚¿ãƒ å•é¡ŒãŒãªã„å ´åˆã¯è¨­å®šã‚’defaultã¾ãŸã¯bothã«å¤‰æ›´
                if (!hasCustomProblems && this.problemSource === 'custom') {
                    this.problemSource = 'both';
                    this.saveSettings();
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                        <h2>âš™ï¸ ${this.t('settingsTitle')}</h2>
                        
                        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                        <div class="tabs">
                            <button class="tab active" onclick="app.switchSettingsTab('general')">ğŸ›ï¸ ${this.t('generalSettings')}</button>
                            <button class="tab" onclick="app.switchSettingsTab('problems')">ğŸ“ ${this.t('problemManagement')}</button>
                        </div>
                        
                        <!-- ä¸€èˆ¬è¨­å®šã‚¿ãƒ– -->
                        <div class="tab-content active" id="settings-tab-general" style="padding: 20px 0;">
                            <div class="settings-panel">
                                <div class="settings-grid">
                                    <div class="setting-group">
                                        <label>ğŸŒ ${this.t('language')}</label>
                                        <select onchange="app.setLanguage(this.value)">
                                            <option value="ja" ${this.language === 'ja' ? 'selected' : ''}>æ—¥æœ¬èª</option>
                                            <option value="en" ${this.language === 'en' ? 'selected' : ''}>English</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>ğŸ“Š ${this.t('difficulty')}</label>
                                        <select id="difficultySelect" onchange="app.setDifficulty(this.value)">
                                            <option value="beginner" ${this.difficulty === 'beginner' ? 'selected' : ''}>${this.t('beginner')}</option>
                                            <option value="intermediate" ${this.difficulty === 'intermediate' ? 'selected' : ''}>${this.t('intermediate')}</option>
                                            <option value="advanced" ${this.difficulty === 'advanced' ? 'selected' : ''}>${this.t('advanced')}</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>ğŸ”¢ ${this.t('problemCount')}</label>
                                        <select onchange="app.setProblemsPerSession(parseInt(this.value))">
                                            <option value="5" ${this.problemsPerSession === 5 ? 'selected' : ''}>5</option>
                                            <option value="10" ${this.problemsPerSession === 10 ? 'selected' : ''}>10</option>
                                            <option value="20" ${this.problemsPerSession === 20 ? 'selected' : ''}>20</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>ğŸ“š ${this.t('problemSource')}</label>
                                        <select onchange="app.setProblemSource(this.value)">
                                            <option value="default" ${this.problemSource === 'default' ? 'selected' : ''}>${this.t('defaultProblems')}</option>
                                            <option value="custom" ${this.problemSource === 'custom' ? 'selected' : ''} ${!hasCustomProblems ? 'disabled' : ''}>${this.t('customProblemsOnly')}${!hasCustomProblems ? ' (' + this.t('noCustomProblems') + ')' : ''}</option>
                                            <option value="both" ${this.problemSource === 'both' ? 'selected' : ''}>${this.t('bothProblems')}</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>ğŸµ ${this.t('soundTheme')}</label>
                                        <select onchange="app.setSoundTheme(this.value)">
                                            <option value="piano" ${this.audioSystem.soundTheme === 'piano' ? 'selected' : ''}>${this.t('piano')}</option>
                                            <option value="drum" ${this.audioSystem.soundTheme === 'drum' ? 'selected' : ''}>${this.t('drum')}</option>
                                            <option value="synth" ${this.audioSystem.soundTheme === 'synth' ? 'selected' : ''}>${this.t('synth')}</option>
                                            <option value="ambient" ${this.audioSystem.soundTheme === 'ambient' ? 'selected' : ''}>${this.t('ambient')}</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>ğŸ”Š ${this.t('volume')}</label>
                                        <input type="range" min="0" max="100" value="${this.audioSystem.masterVolume * 100}" 
                                               oninput="app.setVolume(this.value / 100); document.getElementById('volumeDisplay').textContent = this.value + '%'">
                                        <div class="volume-display" id="volumeDisplay">${Math.round(this.audioSystem.masterVolume * 100)}%</div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border); display: flex; gap: 10px; justify-content: center;">
                                <button onclick="app.resetSettings()">ğŸ”„ ${this.t('resetSettings')}</button>
                                <button onclick="app.exportData()">ğŸ’¾ ${this.t('exportData')}</button>
                            </div>
                        </div>
                        
                        <!-- å•é¡Œç®¡ç†ã‚¿ãƒ– -->
                        <div class="tab-content" id="settings-tab-problems" style="padding: 20px 0;">
                            ${this.getProblemManagementHTML()}
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); text-align: center;">
                            <button class="secondary" onclick="app.closeModal(this)">${this.t('close')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
            }

            switchSettingsTab(tabName) {
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                const modal = document.querySelector('.modal');
                if (!modal) return;
                
                modal.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
                modal.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                event.target.classList.add('active');
                modal.querySelector(`#settings-tab-${tabName}`).classList.add('active');
            }

            getProblemManagementHTML() {
                return `
                    <div style="margin-bottom: 20px;">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            ${this.t('problemManagementDesc')}
                        </p>
                    </div>
                    
                    <!-- é›£æ˜“åº¦ã‚¿ãƒ– -->
                    <div class="tabs" style="margin-bottom: 15px;">
                        <button class="tab active" onclick="app.switchProblemTab('beginner')">ğŸ“˜ ${this.t('beginner')}</button>
                        <button class="tab" onclick="app.switchProblemTab('intermediate')">ğŸ“— ${this.t('intermediate')}</button>
                        <button class="tab" onclick="app.switchProblemTab('advanced')">ğŸ“• ${this.t('advanced')}</button>
                    </div>
                    
                    ${this.getProblemTabContents()}
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border); display: flex; gap: 10px; justify-content: center;">
                        <button onclick="app.exportCustomProblems()">ğŸ“¤ ${this.t('exportProblems')}</button>
                        <button onclick="app.importCustomProblems()">ğŸ“¥ ${this.t('importProblems')}</button>
                    </div>
                `;
            }

            getProblemTabContents() {
                return ['beginner', 'intermediate', 'advanced'].map((difficulty, index) => {
                    const defaultProblems = problemDatabase[difficulty] || [];
                    const customProblems = this.customProblems[difficulty] || [];
                    
                    const defaultProblemsHTML = `
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: var(--accent); font-size: 16px; margin: 0;">ğŸ“š ${this.t('defaultProblems')} (${defaultProblems.length})</h4>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; padding: 10px; background: var(--bg-secondary); border-radius: 5px; border: 1px solid var(--border);">
                                ${defaultProblems.slice(0, 10).map((problem, idx) => `
                                    <div style="padding: 6px; margin-bottom: 3px; font-size: 13px; opacity: 0.8;">
                                        ${idx + 1}. ${this.escapeHtml(problem)}
                                    </div>
                                `).join('')}
                                ${defaultProblems.length > 10 ? `<div style="text-align: center; padding: 10px; opacity: 0.6; font-size: 13px;">...${this.t('andMore', {count: defaultProblems.length - 10})}</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    const customProblemsHTML = customProblems.map((problem, idx) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 5px; border: 1px solid var(--border);">
                            <span style="flex: 1; margin-right: 10px;">${this.escapeHtml(problem)}</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="secondary" style="padding: 5px 12px; font-size: 13px;" data-difficulty="${difficulty}" data-index="${idx}" onclick="app.editProblemByEvent(event)">âœï¸</button>
                                <button class="danger" style="padding: 5px 12px; font-size: 13px;" data-difficulty="${difficulty}" data-index="${idx}" onclick="app.deleteProblemByEvent(event)">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                    
                    const customSection = `
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: var(--accent); font-size: 16px; margin: 0;">âœï¸ ${this.t('customProblemsOnly')} (${customProblems.length})</h4>
                                <button style="padding: 8px 16px; font-size: 14px;" data-difficulty="${difficulty}" onclick="app.showAddProblemDialogByEvent(event)">â• ${this.t('addProblem')}</button>
                            </div>
                            ${customProblems.length > 0 ? `
                                <div style="max-height: 250px; overflow-y: auto;">
                                    ${customProblemsHTML}
                                </div>
                            ` : `<p style="text-align: center; padding: 30px; opacity: 0.6; background: var(--bg-secondary); border-radius: 5px;">${this.t('noCustomProblems')}</p>`}
                        </div>
                    `;
                    
                    return `
                        <div class="tab-content ${index === 0 ? 'active' : ''}" id="problem-tab-${difficulty}">
                            <div style="margin-bottom: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 5px; border-left: 4px solid var(--accent);">
                                <strong>${this.t('totalProblems')}: ${defaultProblems.length + customProblems.length}</strong>
                                <span style="opacity: 0.7; margin-left: 10px; font-size: 14px;">(${this.t('default')}: ${defaultProblems.length} / ${this.t('custom')}: ${customProblems.length})</span>
                            </div>
                            ${defaultProblemsHTML}
                            ${customSection}
                        </div>
                    `;
                }).join('');
            }

            switchProblemTab(difficulty) {
                const modal = document.querySelector('.modal');
                if (!modal) return;
                
                // å•é¡Œç®¡ç†ã‚¿ãƒ–å†…ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
                const problemSection = modal.querySelector('#settings-tab-problems');
                if (!problemSection) return;
                
                problemSection.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
                problemSection.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                problemSection.querySelector(`#problem-tab-${difficulty}`).classList.add('active');
            }

            showHistory() {
                const historyHTML = this.history.slice().reverse().map(record => `
                    <div class="history-item">
                        <div>
                            <div><strong>${new Date(record.date).toLocaleString(this.language === 'ja' ? 'ja-JP' : 'en-US')}</strong></div>
                            <div>${this.t('rank')}: <span class="rank ${record.rank}" style="font-size: 20px;">${record.rank}</span> | 
                                 ${this.t('score')}: ${record.score} | WPM: ${record.wpm} | ${this.t('accuracyRate')}: ${record.accuracy}%</div>
                        </div>
                        <button class="danger" onclick="app.deleteHistory('${record.date}')">${this.t('delete')}</button>
                    </div>
                `).join('');

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2>${this.t('historyTitle')}</h2>
                        <div class="history-panel">
                            ${this.history.length > 0 ? historyHTML : `<p style="text-align: center; padding: 20px;">${this.t('noHistory')}</p>`}
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                            <button class="danger" onclick="app.clearHistory()">${this.t('deleteAll')}</button>
                            <button class="secondary" onclick="app.closeModal(this)">${this.t('close')}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });
            }

            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.saveSettings();
                this.showMessage(this.t('difficultyChanged'));
            }

            setProblemsPerSession(count) {
                this.problemsPerSession = count;
                this.saveSettings();
                this.showMessage(this.t('problemCountChanged'));
            }

            setProblemSource(source) {
                this.problemSource = source;
                this.saveSettings();
                this.showMessage(this.t('problemSourceChanged'));
            }

            setSoundTheme(theme) {
                this.audioSystem.setSoundTheme(theme);
                this.saveSettings();
                this.showMessage(this.t('soundThemeChanged'));
            }

            setVolume(volume) {
                this.audioSystem.setVolume(volume);
                this.saveSettings();
            }

            setLanguage(lang) {
                this.language = lang;
                this.saveSettings();
                this.updateLanguage();
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦å†è¡¨ç¤º
                const modal = document.querySelector('.modal');
                if (modal) modal.remove();
                this.showSettings();
            }

            t(key, params = {}) {
                let text = translations[this.language][key] || key;
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ› ({count} ãªã©)
                Object.keys(params).forEach(param => {
                    text = text.replace(`{${param}}`, params[param]);
                });
                return text;
            }

            updateLanguage() {
                // ãƒ˜ãƒƒãƒ€ãƒ¼
                document.querySelector('h1').textContent = this.t('title');
                document.getElementById('guideBtn').textContent = this.t('guide');
                document.getElementById('historyBtnHeader').textContent = this.t('history');
                document.getElementById('relaxBtn').textContent = this.t('relaxMode');
                document.getElementById('settingsBtn').textContent = this.t('settings');
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼
                document.querySelectorAll('.stat-label')[0].textContent = this.t('progress');
                document.querySelectorAll('.stat-label')[2].textContent = this.t('accuracy');
                document.querySelectorAll('.stat-label')[3].textContent = this.t('time');
                
                // ãƒœã‚¿ãƒ³
                if (!this.isPlaying) {
                    document.getElementById('textDisplay').innerHTML = this.t('startMessage');
                    const startBtn = document.getElementById('startBtn');
                    if (startBtn && !startBtn.classList.contains('hidden')) {
                        startBtn.innerHTML = this.t('start');
                    }
                }
                
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) pauseBtn.innerHTML = this.t('pause');
                
                const resumeBtn = document.getElementById('resumeBtn');
                if (resumeBtn) resumeBtn.innerHTML = this.t('resume');
                
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) resetBtn.innerHTML = this.t('reset');
            }

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.theme);
                this.saveSettings();
            }

            toggleMenu() {
                const dropdown = document.getElementById('menuDropdown');
                const overlay = document.getElementById('menuOverlay');
                
                if (dropdown.classList.contains('active')) {
                    this.closeMenu();
                } else {
                    dropdown.classList.add('active');
                    overlay.classList.add('active');
                }
            }

            closeMenu() {
                const dropdown = document.getElementById('menuDropdown');
                const overlay = document.getElementById('menuOverlay');
                
                dropdown.classList.remove('active');
                overlay.classList.remove('active');
            }

            resetSettings() {
                if (confirm(this.t('confirmReset'))) {
                    this.difficulty = 'beginner';
                    this.problemsPerSession = 10;
                    this.problemSource = 'both';
                    this.audioSystem.setSoundTheme('piano');
                    this.audioSystem.setVolume(0.5);
                    this.saveSettings();
                    this.showMessage(this.t('settingsReset'));
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦å†è¡¨ç¤º
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    this.showSettings();
                }
            }

            saveSettings() {
                const settings = {
                    difficulty: this.difficulty,
                    problemsPerSession: this.problemsPerSession,
                    problemSource: this.problemSource,
                    soundTheme: this.audioSystem.soundTheme,
                    volume: this.audioSystem.masterVolume,
                    theme: this.theme,
                    language: this.language
                };
                localStorage.setItem('typingTrainerSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('typingTrainerSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    this.difficulty = settings.difficulty || 'beginner';
                    this.problemsPerSession = settings.problemsPerSession || 10;
                    this.problemSource = settings.problemSource || 'both';
                    this.audioSystem.setSoundTheme(settings.soundTheme || 'piano');
                    this.audioSystem.setVolume(settings.volume || 0.5);
                    this.theme = settings.theme || 'light';
                    this.language = settings.language || 'en';
                    document.body.setAttribute('data-theme', this.theme);
                }
            }

            saveResult(result) {
                this.history.push(result);
                // æœ€å¤§100ä»¶ã¾ã§ä¿å­˜
                if (this.history.length > 100) {
                    this.history.shift();
                }
                localStorage.setItem('typingTrainerHistory', JSON.stringify(this.history));
            }

            loadHistory() {
                const saved = localStorage.getItem('typingTrainerHistory');
                if (saved) {
                    this.history = JSON.parse(saved);
                }
            }

            deleteHistory(date) {
                if (confirm(this.t('confirmDelete'))) {
                    this.history = this.history.filter(record => record.date !== date);
                    localStorage.setItem('typingTrainerHistory', JSON.stringify(this.history));
                    this.showMessage(this.t('historyDeleted'));
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    this.showHistory();
                }
            }

            clearHistory() {
                if (confirm(this.t('confirmDeleteAll'))) {
                    this.history = [];
                    localStorage.setItem('typingTrainerHistory', JSON.stringify(this.history));
                    this.showMessage(this.t('allHistoryDeleted'));
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                }
            }

            exportData() {
                const data = {
                    settings: {
                        difficulty: this.difficulty,
                        problemsPerSession: this.problemsPerSession,
                        soundTheme: this.audioSystem.soundTheme,
                        volume: this.audioSystem.masterVolume,
                        theme: this.theme,
                        language: this.language
                    },
                    history: this.history
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `typing-trainer-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showMessage(this.t('dataExported'));
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.className = 'message';
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 3000);
            }

            updateUI() {
                // UIæ›´æ–°ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        const app = new TypingTrainerApp();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        window.addEventListener('load', () => {
            app.updateStats();
        });

        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        setInterval(() => {
            if (app.isPlaying && !app.isPaused) {
                app.updateStats();
            }
        }, 1000);
    </script>
</body>
</html>
